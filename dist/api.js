!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApi=t():e.AceApi=t()}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=18)}([function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("@babel/runtime/helpers/interopRequireDefault")},function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(4),a=r(6),c={_id:"config",client:{},assets:{},schemas:[],taxonomies:[],users:[],roles:(new(r(12))).roles(),provider:{},module:{}};e.exports=class{constructor(e){this.config=e}get(){var e;return n.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return e=c,t.prev=1,t.next=4,n.default.awrap(i.connect(this.config).get("config"));case 4:e=t.sent,e=s.merge({},c,e),t.next=10;break;case 8:t.prev=8,t.t0=t.catch(1);case 10:return e.slug=this.config.slug,t.abrupt("return",e);case 12:case"end":return t.stop()}},null,this,[[1,8]])}set(e){return n.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return e._id="config",delete e.roles,t.next=4,n.default.awrap(a.createOrUpdate(this.config,e));case 4:return e=t.sent,e=s.merge({},c,e),t.abrupt("return",e);case 7:case"end":return t.stop()}},null,this)}}},function(e,t,r){"use strict";const n=r(11);class s{constructor(e,t){return this.config=e,s.connect(e,t)}static connect(e,t){return new n({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}e.exports=s},function(e,t){e.exports=require("bluebird")},function(e,t,r){"use strict";const n=r(0),s=r(5),i=r(4);e.exports=class{constructor(e){this.config=e,this.assistUrl=e.assist.url,this.slug=e.slug}static createOrUpdate(e,t){return new s((r,n)=>{i.connect(e).insert(t).then(e=>{t._id=e.id,t._rev=e.rev,r(t)},s=>{409===s.statusCode?i.connect(e).get(t._id).then(s=>{t._rev=s._rev,i.connect(e).insert(t).then(e=>{t._rev=e.rev,r(t)},n)},n):n(s)})})}static chunkUpdate(e,t,r=1e3){return new s((a,c)=>{const o=n.chunk(t,r),u=[];o.forEach(t=>{u.push(new s((r,n)=>{i.connect(e).bulk({docs:t}).then(r,n)}))}),s.all(u).then(a,c)})}static groupEntities(e,t=1/0){const r=[];let n={entities:[]};return e.forEach(e=>{(!e.groupBefore||n.entities.length>=t)&&(n={entities:[]}),n.entities.push(e),(!e.groupAfter||n.entities.length>=t)&&(n.ratio=0,n.entities.forEach(e=>{n.ratio+=(e.thumbnail||e).ratio}),n.entities.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/n.ratio}),r.push(n))}),r}static now(){return JSON.stringify(new Date).replace(/"/g,"")}static replace(e,t,r){return e.map(e=>e[r]===t[r]?t:e)}thumbnailSrc(e,t,r,s){if(!e)return"";let i;"string"==typeof t&&(i=t.split(/,|;/),t={},i.forEach(e=>{e=e.split(/_|:/),t[e[0]]=e[1]}));const a=!!e.crops&&e.crops[r];a?(t.x=a[0],t.y=a[1],t.x2=a[2],t.y2=a[3]):s&&(t.g=s),i=[],n.forEach(t,(e,t)=>{i.push([t,e].join(":"))});const c=i.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",c,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",c,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){const t=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",c,t].join("/")}return""}}},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("fs")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(8),a=r(20),c=r(3);e.exports=class{constructor(e){this.config=e}deleteFiles(e){var t,r,o,u;return n.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return t=new c(this.config),l.next=3,n.default.awrap(t.get());case 3:if(r=l.sent,o=s.get(r,"assets.slug",this.config.slug),0!==e.length){l.next=7;break}return l.abrupt("return",[]);case 7:return l.next=9,n.default.awrap(i.post(`${this.config.assist.url}/${o}/file/delete`,{fileNames:e},{auth:{username:this.config.assist.username,password:a.generate(this.config.assist.password)}}));case 9:return u=l.sent.data,l.abrupt("return",u);case 11:case"end":return l.stop()}},null,this)}}},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t,r){"use strict";const n=r(0),s=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,userSettings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,userSettings:!0,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,userSettings:!1,tools:!1,ecommerce:!1}}];e.exports=class{roles(){return s.map(e=>Object.freeze(e))}role(e){return n.find(this.roles(),{slug:e})}}},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(7),i=r(5),a=i.promisifyAll(r(9)),c=r(0),o=r(24),u=i.promisifyAll(r(25)),l=r(26),d=r(27).Inky,p=r(28),f=r(29).registerComponent,h=r(30).registerDependencies,{McSection:m,McImage:g}=r(31),y=r(32),v=r(33),x=r(34),w=i.promisifyAll(r(35)),_=r(36),b=r(37),E=r(38),S=r(3),k=r(6);e.exports=class{constructor(e){this.config=e,this.inky=new d,f(m),f(g),h({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}getTemplate(e,t={},r={}){var i,o,u,l,d,f,h,m,g,T,A;return n.default.async(function(I){for(;;)switch(I.prev=I.next){case 0:return i=c.merge({},{inlineStyles:!0,inky:!1,mjml:!1,skipValidation:!1},r),o=s.join(this.config.email.templatesPath,e),I.prev=2,I.next=5,n.default.awrap(a.statAsync(o));case 5:I.next=10;break;case 7:I.prev=7,I.t0=I.catch(2),o=s.resolve("../email",e);case 10:return I.next=12,n.default.awrap(a.readdirAsync(o));case 12:if(u=I.sent,l="html",c.find(u,e=>/^html\.mjml/.test(e))&&(l="html.mjml",i.mjml=!0),d="html",c.find(u,e=>/\.pug$/.test(e))&&(d="pug"),c.find(u,e=>/\.ejs$/.test(e))&&(d="ejs"),f="",!c.find(u,e=>/^style\.scss$/.test(e))){I.next=23;break}return I.next=22,n.default.awrap(w.renderAsync({file:s.join(o,"style.scss"),sourceMapContents:!i.inlineStyles,sourceMapEmbed:!i.inlineStyles}));case 22:f=I.sent.css.toString().replace(/"/g,"'");case 23:return h=new S(this.config),I.next=26,n.default.awrap(h.get());case 26:if(m=I.sent,g=new k(this.config),t=c.merge({},t,{config:c.merge({},c.pick(this.config,["cms"]),c.pick(m,["slug","client","assets"])),helpers:g,style:f,moment:v,countries:x,templateSlug:e}),"html"===d&&(T=a.readFileAsync(`${o}/${l}.${d}`)),"pug"===d&&(T=_.renderFile(`${o}/${l}.${d}`,t)),"ejs"!==d){I.next=35;break}return I.next=34,n.default.awrap(b.renderFile(`${o}/${l}.${d}`,t));case 34:T=I.sent;case 35:if(!i.mjml){I.next=40;break}if(!(A=p(T,{level:i.skipValidation?"skip":"soft"})).errors||!A.errors.length){I.next=39;break}throw new Error(c.uniq(A.errors.map(e=>e.formattedMessage)).join("\n"));case 39:T=A.html;case 40:return i.inky&&(T=this.inky.releaseTheKraken(T)),i.inlineStyles&&(T=E(T,{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}})),I.abrupt("return",{html:T,text:y.fromString(T)});case 43:case"end":return I.stop()}},null,this,[[2,7]])}sendEmail(e,t,r={},n={}){return new i((s,i)=>{const a=o.createTransport(l({auth:{api_key:this.config.mailgun.apiKey,domain:this.config.mailgun.domain}}));this.getTemplate(t,c.merge({},e,r),n).then(t=>{e.html=t.html,e.text=t.text,a.sendMail(e,(t,r)=>{t?i(t):s({metadata:r,email:e})})},i)})}subscribe(e,t,r){return new i((n,s)=>{new S(this.config).get().then(a=>{if("createsend"===t){if(a.provider.createsend){const t=new u({apiKey:a.provider.createsend.clientApiKey});return void i.promisifyAll(t.subscribers).addSubscriberAsync(r,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(e=>{n(`Email.subscribe(): ${e.emailAddress}`)}).catch(e=>{s(e.Message)})}s(new Error("Subscriber list not configured"))}},s)})}}},function(e,t,r){"use strict";var n=r(1),s=n(r(2)),i=n(r(41));const a=r(0),c=r(5),o=r(42),{diff:u}=r(43),l=r(3),d=r(4),p=r(6),f=r(15),h=r(10),m=1e3;class g{constructor(e){this.config=e,this.flattenValues=g.flattenValues}static flattenValues(e){return e.map(e=>e.fields&&a.size(e.fields)?(e.fields=a.mapValues(e.fields,e=>(/entity/.test(e.type)&&a.isArray(e.value)&&(e.value=g.flattenValues(e.value)),e.value)),e):e)}static _filterEntityFields(e,t="guest"){const r=a.isArray(e);return e=(r?e:[e]).map(e=>(a.size(e.fields)&&(e.fields=a.mapValues(e.fields,e=>(a.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published)))),e))),e)),r?e:e[0]}static _appendChildren(e,t){return e.map(e=>a.size(e.fields)?(e.fields=a.mapValues(e.fields,e=>(a.isArray(e.value)&&(e.value=e.value.filter(e=>!!e&&("entity"!==e.type||void 0!==t[e.id])),e.value=e.value.map(e=>("entity"===e.type&&(e=a.merge(e,t[e.id])),e=a.omitBy(e,(e,t)=>t.startsWith("_"))))),e)),e):e)}static _appendParents(e,t=null,r="guest"){let n={};return e.forEach(e=>{e.doc&&"entity"===e.value.type&&(n[e.id]=(0,i.default)({},e.doc,{parents:[]}))}),t&&(e.forEach(e=>{e.doc&&"parent"===e.value.type&&n[e.key].parents.push(g._filterEntityFields(e.doc,r))}),n=a.mapValues(n,e=>(e.parents=a.uniqBy(e.parents,e=>e._id),e))),e=(e=e.map(e=>(e.doc=n[e.id],e))).filter(e=>"entity"===e.value.type)}static _fileNames(e){const t=[];return e.forEach(e=>{a.forEach(e.fields,e=>{e.value&&e.value.file&&t.push(e.value.file.name)})}),a.uniq(t)}fieldValues(e,t){var r;return s.default.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,s.default.awrap(d.connect(this.config).viewWithList("entity","byField","search",{startkey:[e],endkey:[e,{}],group:!0,searchTerm:t}));case 2:return r=n.sent,n.abrupt("return",r);case 4:case"end":return n.stop()}},null,this)}static _query(e,t,r=!1){if(t=t.replace(/(\s\s|\t|\r|\n)/g,""),r){const e=t.trim().split(/\[|\]/),r=`fields.${e[0]}.value[${e[1]||"*"}]`,n=/\]:/.test(t)?`:${t.split(/\]:/).slice(-1)[0].trim()}`:"";t=`${r}${n}`}return o(t,{data:e,locals:{slice:(e,t,r)=>a.slice(e,t,r),sample:(e,t=1)=>a.sampleSize(e,t),group:(e,t=1/0)=>{const r=[];let n=[];return e.forEach(e=>{(!e.groupBefore||n.length>=t)&&(n=[]),n.push(e),(!e.groupAfter||n.length>=t)&&(n.ratio=0,n.forEach(e=>{n.ratio+=(e.thumbnail||e).ratio}),n.forEach(e=>{e.groupRatio=(e.thumbnail||e).ratio/n.ratio}),r.push(n))}),r},pick:(e,...t)=>a.map(e,e=>{const r={id:e.id||void 0};return(t=t.filter(e=>e)).forEach(t=>{const n=t.match(/([^\s]+)/g),s=n[0],i=n[n.length-1];a.set(r,i,a.get(e,s))}),r})},allowRegexp:!0})}static _queriesFromString(e){const t=(e=e.replace(/(\s\s|\t|\r|\n)/gm,"")).match(/\(([^)]+)\)/g);let r=(e=e.replace(/\(.*?\)/g,"()")).split(/,(?![^([]*[\])])/g);return r=r.map(e=>{const r=e.match(/\(\)/g);return r&&a.times(r.length,()=>{e=e.replace("()",t.splice(0,1))}),e.trim()})}_entitiesById(e=[],t={}){var r,n;return s.default.async(function(i){for(;;)switch(i.prev=i.next){case 0:return t=a.merge({parents:!1,role:"guest"},t),r={include_docs:!0},e.length&&(r.keys=e),i.next=5,s.default.awrap(d.connect(this.config).view("entity",t.parents?"byIdExtended":"byId",r));case 5:return(n=i.sent).rows=n.rows.map(e=>(e.doc=g._filterEntityFields(e.doc,t.role),e)),n.rows=g._appendParents(n.rows,t.parents,t.role),i.abrupt("return",n);case 9:case"end":return i.stop()}},null,this)}static _childDepthLimit(e){let t=0;return a.isNumber(e)&&(t=e-1),a.isArray(e)&&(t=e.length-1),t}_getDocMap(e,t={},r={}){var n,c,o;return s.default.async(function(u){for(;;)switch(u.prev=u.next){case 0:if(r._childDepth=r._childDepth||0,r.parents||r.children){u.next=3;break}return u.abrupt("return",t);case 3:if(n=[],c=[],e.forEach(e=>{const t=!!e.doc;let s=t?e.doc:e;s=g._filterEntityFields(s,r.role),r.children&&s.fields&&a.size(s.fields)&&(a.isArray(r.children)?g._queriesFromString(r.children[r._childDepth]).forEach(e=>{c=c.concat(a.flatten(g._query(s,e,!0).value).map(e=>e&&e.id))}):a.forEach(s.fields,e=>{a.isArray(e.value)&&(e.value=e.value.filter(e=>e),e.value.forEach(e=>{e.id&&c.push(e.id)}))})),n.push(t?e.id:s._id||s.id)}),n=(n=a.uniq(n)).filter(e=>!t[e]),[],!(n.length>0)){u.next=15;break}return u.next=12,s.default.awrap(this._entitiesById(n,r));case 12:u.t0=(e=>e.doc),u.sent.rows.map(u.t0).forEach(e=>{t[e._id]=e});case 15:if(c=(c=a.uniq(c)).filter(e=>!t[e]),o=[],!(c.length>0)){u.next=24;break}return u.next=21,s.default.awrap(this._entitiesById(c,(0,i.default)({},r,{parents:!1})));case 21:u.t1=(e=>e.doc),(o=u.sent.rows.map(u.t1)).forEach(e=>{t[e._id]=e});case 24:if(r.children&&r._childDepth!==g._childDepthLimit(r.children)){u.next=26;break}return u.abrupt("return",t);case 26:return u.next=28,s.default.awrap(this._getDocMap(o,t,(0,i.default)({},r,{parents:!1,_childDepth:r._childDepth+1})));case 28:return t=u.sent,u.abrupt("return",t);case 30:case"end":return u.stop()}},null,this)}static _mergeDocs(e,t,r={children:!1,parents:!1}){return r._childDepth=r._childDepth||0,r.children&&r._childDepth-1===g._childDepthLimit(r.children)?e:e=e.map(e=>{const n=!!e.doc;let s=n?e.doc:e;if(t[e.id||e._id]&&(s=a.merge({},s,t[e.id||e._id])),r.children&&s.fields&&a.size(s.fields)){let e;a.isArray(r.children)&&(e={},g._queriesFromString(r.children[r._childDepth]).forEach(t=>{const r=t.split(/\[|\]/)[0];e[r]=t})),s.fields=a.mapValues(s.fields,(n,s)=>(a.isArray(n.value)&&(n.value=n.value.filter(e=>e),(!e||e&&e[s])&&(e&&e[s]&&(n.value=n.value.filter(e=>e.id&&t[e.id])),n.value=n.value.map(e=>(e&&e.id&&t[e.id]&&(e=a.merge(e,t[e.id]||{}),e=a.omitBy(e,(e,t)=>t.startsWith("_"))),e)),n.value=g._mergeDocs(n.value,t,(0,i.default)({},r,{_childDepth:r._childDepth+1})))),n)),s.fields=a.mapValues(s.fields,(t,r)=>(a.isArray(t.value)&&e&&e[r]&&(t.value=a.flatten(g._query(s,e[r],!0).value)),t))}return a.isArray(r.parents)&&s.parents&&(s.parents=a.flatten(g._query(s.parents,r.parents[0]).value)),n?e.doc=s:e=s,e})}_extendRowsOrDocs(e,t={}){var r;return s.default.async(function(n){for(;;)switch(n.prev=n.next){case 0:return t=a.merge({select:!1,children:!1,parents:!1,role:"guest"},t),n.next=3,s.default.awrap(this._getDocMap(e,{},t));case 3:return r=n.sent,e=g._mergeDocs(e,r,t),t.select&&(e=a.flatten(g._query(e,t.select).value)),r=null,n.abrupt("return",e);case 8:case"end":return n.stop()}},null,this)}_removeChildren(e){return new c((t,r)=>{0!==e.length?(e=e.map(e=>e._id),d.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(n=>{const s=a.uniqBy(n.rows,e=>e.doc._id).map(t=>(t.doc.fields=a.mapValues(t.doc.fields,t=>(a.isArray(t.value)&&(t.value=a.filter(t.value,t=>!("entity"===t.type&&-1!==e.indexOf(t.id)))),t)),t.doc));0!==s.length?p.chunkUpdate(this.config,s,m).then(t,r):t([])},r)):t([])})}_updateChildren(e){return new c((t,r)=>{if(0===e.length)return void t([]);const n={};e=e.map(e=>(n[e._id]=e,e._id)),d.connect(this.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(e=>{const s=e.rows.map(e=>{const t=e.doc;return a.forEach(t.fields,(e,r)=>{a.isArray(e.value)&&(t.fields[r].value=e.value.filter(e=>e).map(e=>("entity"===e.type&&n[e.id]&&(e.slug=n[e.id].slug,e.title=n[e.id].title,e.schema=n[e.id].schema,e.published=n[e.id].published,n[e.id].thumbnail?e.thumbnail=n[e.id].thumbnail:e.thumbnail=null),e)))}),t});p.chunkUpdate(this.config,s,m).then(t,r)},r)})}entityList(e=[],t={}){var r,n;return s.default.async(function(i){for(;;)switch(i.prev=i.next){case 0:return t=a.merge({select:!1,children:!1,parents:!1,role:"guest"},t),i.next=3,s.default.awrap(this._entitiesById(e,t));case 3:return r=i.sent,i.next=6,s.default.awrap(this._extendRowsOrDocs(r.rows,t));case 6:return n=i.sent,i.abrupt("return",n);case 8:case"end":return i.stop()}},null,this)}_entitySearch(e,t={}){return new c((r,n)=>{e.limit=Math.min(e.limit||200,200),e.sort=a.isString(e.sort)?`"${e.sort}"`:e.sort,t.children&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),a.isArray(e.include_fields)&&(e.include_fields=JSON.stringify(e.include_fields)),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,d.connect(this.config).search("entity",e.index||"all",e).then(e=>{if(e.groups){const s=[];return e.groups=e.groups.map(e=>(s.push(new c((r,n)=>{(t.children||t.parents)&&0!==e.total_rows?this._extendRowsOrDocs(e.hits,t).then(t=>{e.hits=t,r()},n):r()})),e)),void c.all(s).then(()=>{r(e)},n)}this._extendRowsOrDocs(e.rows,t).then(t=>{e.rows=t,r(e)},n)},n)})}entitySearch(e,t={}){return t=a.merge({children:!1,parents:!1,role:"guest"},t),new c((r,n)=>{const s=e.limit||25;if(s<=200)return void this._entitySearch(e,t).then(r,n);let i=[],c=[];(function o(u){const l=a.clone(e);u&&(l.bookmark=u),this._entitySearch(l,t).then(e=>{e.rows&&(i=i.concat(e.rows)),e.groups&&(c=c.concat(e.groups)),i.length<e.total_rows&&i.length<s?o.call(this,e.bookmark):(e.rows=i,e.groups=c,r(e))},n)}).call(this)})}entityFind(e,t={}){var r,n,i,c;return s.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return t=a.merge({children:!1,parents:!1,role:"guest"},t),o.prev=1,o.next=4,s.default.awrap(d.connect(this.config).find(e));case 4:r=o.sent,o.next=20;break;case 7:if(o.prev=7,o.t0=o.catch(1),"no_usable_index"!==o.t0.error){o.next=20;break}return n=new l(this.config),o.next=13,s.default.awrap(n.get());case 13:return i=o.sent,c=new f(this.config),o.next=17,s.default.awrap(c.updateEntityIndex(i.schemas));case 17:return o.next=19,s.default.awrap(d.connect(this.config).find(e));case 19:r=o.sent;case 20:if(!1!==t.children){o.next=22;break}return o.abrupt("return",r);case 22:if(!e.fields||-1!==e.fields.indexOf("_id")){o.next=24;break}throw new Error("_id field required for `children`");case 24:return o.next=26,s.default.awrap(this._extendRowsOrDocs(r.docs,t));case 26:return r.docs=o.sent,o.abrupt("return",r);case 28:case"end":return o.stop()}},null,this,[[1,7]])}entityRevisions(e){return new c((t,r)=>{d.connect(this.config).get(e,{revs_info:!0}).then(n=>{const s=[];n._revs_info.forEach(e=>{"available"===e.status&&s.push(e.rev)}),d.connect(this.config).get(e,{open_revs:JSON.stringify(s)}).then(e=>{const n=[],s=[];e.forEach(e=>{e.ok&&(n.push(e.ok),a.forEach(e.ok.fields,e=>{/entity/.test(e.type)&&a.forEach(e.value,e=>{e.id&&s.push(e.id)})}))}),d.connect(this.config).fetch({keys:a.uniq(s),include_docs:!0}).then(e=>{const r={};e.rows.forEach(e=>{try{r[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),t(g._appendChildren(n,r))},r)},r)},r)})}entityCreate(e){return new c((t,r)=>{e.type="entity",d.connect(this.config).insert(e).then(r=>{e._id=r.id,e._rev=r.rev,t(e)},r)})}entityRead(e){return new c((t,r)=>{d.connect(this.config).get(e).then(t,r)})}entityUpdate(e,t){var r,n,i,c,o,l;return s.default.async(function(f){for(;;)switch(f.prev=f.next){case 0:return e=a.isArray(e)?e:[e],r={},n=e.map(e=>{let t;return a.isObject(e)&&(t=e._id,r[t]=e),a.isString(e)&&(t=e),t}),f.next=5,s.default.awrap(d.connect(this.config).fetch({keys:n,include_docs:!0}));case 5:if(i=f.sent,c=[],o=[],e=i.rows.map(e=>{const s=e.doc,i=r[s._id];let l=s;if(i){delete i._rev,u(s,i).forEach(e=>{if(/published|slug|title|thumbnail/.test(e.path[0])&&-1===c.indexOf(i)&&-1!==n.indexOf(i._id)&&c.push(i),"fields"===e.path[0]&&"value"===e.path[2]){const t=s.fields[e.path[1]];/attachment|image|audio|video/.test(t.type)&&t.value&&o.push(t.value.file.name)}}),l=a.mergeWith({},s,i,(e,t)=>{if(a.isArray(e)&&a.isArray(t))return t})}return t&&(l.trashed=!1),l}),o.length,!c.length){f.next=13;break}return f.next=13,s.default.awrap(this._updateChildren(c));case 13:return f.next=15,s.default.awrap(p.chunkUpdate(this.config,e,m));case 15:return l=f.sent,f.abrupt("return",l);case 17:case"end":return f.stop()}},null,this)}entityDelete(e,t=!1){var r,n,i,c,o;return s.default.async(function(u){for(;;)switch(u.prev=u.next){case 0:if("trashed"!==e){u.next=7;break}return t=!0,u.next=4,s.default.awrap(d.connect(this.config).view("entity","trashed",{include_docs:!0}));case 4:r=u.sent.rows,u.next=10;break;case 7:return u.next=9,s.default.awrap(d.connect(this.config).fetch({keys:a.isArray(e)?e:[e],include_docs:!0}));case 9:r=u.sent.rows;case 10:return r=(r=r.filter(e=>!e.value||!e.value.deleted)).map(e=>e.doc),u.next=14,s.default.awrap(this._removeChildren(r));case 14:if(!t){u.next=24;break}if(!(i=g._fileNames(r)).length){u.next=21;break}return c=new h(this.config),u.next=20,s.default.awrap(c.deleteFiles(i));case 20:n=u.sent;case 21:r=r.map(e=>({_id:e._id,_rev:e._rev,_deleted:!0})),u.next=25;break;case 24:r=r.map(e=>(e.trashed=!0,e));case 25:return u.next=27,s.default.awrap(p.chunkUpdate(this.config,r,m));case 27:return o=u.sent,u.abrupt("return",{entities:o,files:n});case 29:case"end":return u.stop()}},null,this)}}e.exports=g},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(3),a=r(4),c=r(16);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return t=new i(this.config),s.next=3,n.default.awrap(t.get());case 3:return(r=s.sent).schemas.push(e),s.next=7,n.default.awrap(this.updateEntityIndex(r.schemas));case 7:return s.abrupt("return",t.set(r));case 8:case"end":return s.stop()}},null,this)}read(e){var t,r,a;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,a=s.find(r.schemas,{slug:e})){c.next=7;break}throw Error(`Schema not found: ${e}`);case 7:return c.abrupt("return",a);case 8:case"end":return c.stop()}},null,this)}update(e){var t,r,a;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(a=s.findIndex(r.schemas,{slug:e.slug}))){c.next=7;break}throw Error(`Schema not found: ${e.slug}`);case 7:return r.schemas.splice(a,1,e),c.next=10,n.default.awrap(this.updateEntityIndex(r.schemas));case 10:return c.abrupt("return",t.set(r));case 11:case"end":return c.stop()}},null,this)}delete(e){var t,r;return n.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:return t=new i(this.config),a.next=3,n.default.awrap(t.get());case 3:return r=a.sent,e=s.isArray(e)?e:[e],r.schemas=r.schemas.filter(t=>-1===e.indexOf(t.slug)),r.schemas=r.schemas.map(t=>t.fields?(t.fields=t.fields.map(t=>t.settings?(t.settings.schemas&&(t.settings.schemas=t.settings.schemas.filter(t=>-1===e.indexOf(t))),t):t),t):t),a.next=9,n.default.awrap(this.updateEntityIndex(r.schemas));case 9:return a.abrupt("return",t.set(r));case 10:case"end":return a.stop()}},null,this)}updateAll(e){var t,r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return t=new i(this.config),s.next=3,n.default.awrap(t.get());case 3:return(r=s.sent).schemas=e,s.abrupt("return",t.set(r));case 6:case"end":return s.stop()}},null,this)}updateEntityIndex(e){var t,r,i;return n.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return t=[],e.forEach(e=>{t=t.concat(e.fields)}),t=s.uniqBy(t,"slug"),r={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},t.forEach(e=>{const t=c.field(e.type);/number|string|boolean/.test(t.dataType)&&r.index.fields.push({name:`fields.${e.slug}.value`,type:t.dataType}),/array/.test(t.dataType)&&r.index.fields.push({name:`fields.${e.slug}.value.[].slug`,type:"string"}),/taxonomy/.test(e.type)&&r.index.fields.push({name:`fields.${e.slug}.value.terms.[].slug`,type:"string"})}),o.next=7,n.default.awrap(a.connect(this.config).index(r));case 7:return i=o.sent,o.abrupt("return",i);case 9:case"end":return o.stop()}},null,this)}}},function(e,t,r){"use strict";const n=r(0),s=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"user",name:"User",dataType:"array"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}];class i{static fields(){return s.map(e=>Object.freeze(e))}static field(e){return n.find(i.fields(),{type:e})}}e.exports=i},function(e,t){e.exports=require("request-promise")},function(e,t,r){"use strict";function n(){}n.defaultConfig=r(19),n.Assist=((...e)=>new(r(10))(...e)),n.Auth=((...e)=>new(r(21))(...e)),n.ClientConfig=((...e)=>new(r(3))(...e)),n.Db=((...e)=>new(r(4))(...e)),n.Ecommerce=((...e)=>new(r(23))(...e)),n.Email=((...e)=>new(r(13))(...e)),n.Embedly=((...e)=>new(r(39))(...e)),n.Entity=((...e)=>new(r(14))(...e)),n.Fields=((...e)=>new(r(16))(...e)),n.Helpers=((...e)=>new(r(6))(...e)),n.Instagram=((...e)=>new(r(44))(...e)),n.Jwt=((...e)=>new(r(45))(...e)),n.Pdf=((...e)=>new(r(47))(...e)),n.Roles=((...e)=>new(r(12))(...e)),n.Schema=((...e)=>new(r(15))(...e)),n.Settings=((...e)=>new(r(51))(...e)),n.Shippo=((...e)=>new(r(52))(...e)),n.Shopify=((...e)=>new(r(54))(...e)),n.Stripe=((...e)=>new(r(58))(...e)),n.Taxonomy=((...e)=>new(r(61))(...e)),n.Tools=((...e)=>new(r(62))(...e)),n.User=((...e)=>new(r(63))(...e)),e.exports=n},function(e,t,r){"use strict";(function(t){const n=r(7),s={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},cms:{title:process.env.CMS_TITLE,url:process.env.CMS_URL},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},pdf:{templatesPath:n.resolve(t,"pdf")},email:{templatesPath:n.resolve(t,"email")},provider:{google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},spotify:{clientId:process.env.SPOTIFY_CLIENT_ID,clientSecret:process.env.SPOTIFY_CLIENT_SECRET},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET}}};e.exports=s}).call(this,"/")},function(e,t){e.exports=require("password-hash")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(22),a=r(8),c=r(3),o=r(4),u={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token",spotify:"https://accounts.spotify.com/api/token"};e.exports=class{constructor(e){this.config=e}authoriseUser(e,t){var r,i;return n.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.config.auth.superUserId.split(",").map(e=>e.trim()).indexOf(t)>-1)){a.next=3;break}return a.abrupt("return",{id:t,role:"super"});case 3:return a.next=5,n.default.awrap(o.connect(this.config,e).get("config"));case 5:if(r=a.sent,i=s.find(r.users,{id:t})){a.next=9;break}throw Error(`User not found: ${t}`);case 9:if(i.active){a.next=11;break}throw Error(`User not active: ${t}`);case 11:return a.abrupt("return",i);case 12:case"end":return a.stop()}},null,this)}authProvider(e,t={},r=null,o=!1){var l,d,p,f,h,m,g;return n.default.async(function(y){for(;;)switch(y.prev=y.next){case 0:return l=new c(this.config),y.next=3,n.default.awrap(l.get());case 3:return d=y.sent,p=s.merge({},this.config.provider[e],t||{}),f=r?s.get(d,["userSettings",r,"provider",e],{}):s.get(d,["provider",e],{}),h={grant_type:o?"refresh_token":"authorization_code",code:t&&t.code?t.code:void 0,client_id:p.clientId,client_secret:p.clientSecret,redirect_uri:p.redirectUri,refresh_token:f.refresh_token},m=u[e],y.prev=8,y.next=11,n.default.awrap(a.post(m,i.stringify(h)));case 11:g=y.sent.data,y.next=17;break;case 14:throw y.prev=14,y.t0=y.catch(8),new Error(JSON.stringify(y.t0.response.data));case 17:if((f=s.merge({},f,g)).begins=Math.floor((new Date).getTime()/1e3),"google"!==e){y.next=29;break}return y.prev=20,y.next=23,n.default.awrap(a.get(`https://www.googleapis.com/plus/v1/people/me?access_token=${f.access_token}`));case 23:f.user=y.sent.data,y.next=29;break;case 26:y.prev=26,y.t1=y.catch(20),console.error(y.t1);case 29:if("spotify"!==e){y.next=39;break}return y.prev=30,y.next=33,n.default.awrap(a.get(`https://api.spotify.com/v1/me?access_token=${f.access_token}`));case 33:f.user=y.sent.data,y.next=39;break;case 36:y.prev=36,y.t2=y.catch(30),console.error(y.t2);case 39:return r?s.set(d,["userSettings",r,"provider",e],f):s.set(d,["provider",e],f),y.abrupt("return",l.set(d));case 41:case"end":return y.stop()}},null,this,[[8,14],[20,26],[30,36]])}}},function(e,t){e.exports=require("querystring")},function(e,t,r){"use strict";const n=r(0),s=r(5),i=r(4),a=r(6);e.exports=class{constructor(e){this.config=e}getType(e,t){return new s((r,s)=>{t.sort=n.isString(t.sort)?`"${t.sort}"`:t.sort,i.connect(this.config).search("ecommerce",e,t).then(r,s)})}setType(e,t){return new s((r,n)=>{t.type=e,a.createOrUpdate(this.config,t).then(r,n)})}deleteType(e){return new s((t,r)=>{e=e.map(e=>({_id:e._id,_rev:e._rev,_deleted:!0})),a.chunkUpdate(this.config,e,1e3).then(t,r)})}getOrder(e){return new s((t,r)=>{i.connect(this.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(e=>{e.rows.length?t(e.rows[0].doc):r(new Error("Order not found"))},r)})}verifyDiscount(e){return new s((t,r)=>{i.connect(this.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(n=>{if(n.rows.length){const e=n.rows[0].doc,s=(new Date).getTime(),i=new Date(Date.parse(e.dateStart)).getTime(),a=new Date(Date.parse(e.dateEnd)).getTime();if(i>s)return void r(new Error("Discount not valid (not begun)"));if(a<s)return void r(new Error("Discount not valid (expired)"));t(e)}else r(new Error({statusCode:404,message:`Discount code not found (${e})`}))},r)})}}},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml-mailchimp")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("node-sass")},function(e,t){e.exports=require("pug")},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("juice")},function(e,t,r){"use strict";const n=r(0),s=r(5),i=r(40);e.exports=class{constructor(e){this.config=e}oembed(e){return new s((t,r)=>{const s=new i({key:this.config.embedly.apiKey}),a={urls:n.isArray(e)?e:[e],format:"json"};s.oembed(a,(e,n)=>{e?r(e):t(n)})})}}},function(e,t){e.exports=require("embedly")},function(e,t){e.exports=require("@babel/runtime/helpers/objectSpread")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("deep-diff")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(17);e.exports=class{constructor(e){this.options=s.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{})}_request(e,t,r){var a,c;return n.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return(a={method:e,url:[this.options.host,this.options.version,t].join("/"),qs:{access_token:r.access_token||this.options.access_token,client_id:r.client_id||this.options.client_id}}).qs=s.extend({},a.qs,r),o.next=4,n.default.awrap(i(a));case 4:return c=o.sent,o.abrupt("return",JSON.parse(c));case 6:case"end":return o.stop()}},null,this)}get(e,t){return this._request("GET",e,t)}}},function(e,t,r){"use strict";const n=r(46);e.exports=class{constructor(e){this.config=e}signToken(e,t={}){return n.sign(e,this.config.auth.tokenSecret,t)}verifyToken(e){return n.verify(e,this.config.auth.tokenSecret)}}},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(9),i=r(7),a=r(0),c=r(48),o=r(17),u=r(49),l=r(14),d=r(3);e.exports=class{constructor(e){this.config=e}getTemplates(){var e;return n.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return e={},t.next=3,n.default.awrap(u(this.config.pdf.templatesPath));case 3:return t.sent.forEach(t=>{if(!/\.js$/.test(t))return;const n=t.replace(`${this.config.pdf.templatesPath}/`,"").replace(".js","");e[n]=r(50)(t)}),t.abrupt("return",e);case 6:case"end":return t.stop()}},null,this)}getPayload(e,t,r){var a,o,u,d;return n.default.async(function(p){for(;;)switch(p.prev=p.next){case 0:return a=c(s.readFileSync(i.join(this.config.pdf.templatesPath,`${e}.js`),"utf-8"),`${e}.js`,{},!0),o=new l(this.config),p.next=4,n.default.awrap(o.entityList([t],{children:2,role:r}));case 4:if(p.t0=(e=>e.doc),0!==(u=p.sent.map(p.t0)).length){p.next=8;break}throw new Error("Entity not found");case 8:return d=a(l.flattenValues(u)[0]),p.abrupt("return",d);case 10:case"end":return p.stop()}},null,this)}getPdf(e){var t,r,s,i,c;return n.default.async(function(u){for(;;)switch(u.prev=u.next){case 0:return t=new d(this.config),u.next=3,n.default.awrap(t.get());case 3:return r=u.sent,s=a.get(r,"assets.slug",this.config.slug),i=`${this.config.assist.url}/${s}/pdf/download`,e="object"==typeof e?JSON.stringify(e).replace(/'/gi,"’"):e,u.next=9,n.default.awrap(o({method:"POST",uri:i,encoding:null,form:{payload:e}}));case 9:return c=u.sent,u.abrupt("return",c);case 11:case"end":return u.stop()}},null,this)}}},function(e,t){e.exports=require("eval")},function(e,t){e.exports=require("recursive-readdir")},function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=50},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(3);e.exports=class{constructor(e){return this.config=e,this}update(e){var t,r;return n.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:return t=new i(this.config),a.next=3,n.default.awrap(t.get());case 3:return(r=a.sent).client=s.merge({},r.client,e),a.abrupt("return",t.set(r));case 6:case"end":return a.stop()}},null,this)}}},function(e,t,r){"use strict";const n=r(5),s=r(53);e.exports=class{constructor(e){this.config=e,this.shippo=s(e.shippo.token)}getQuote(e,t){return new n((r,n)=>{const s={object_purpose:"QUOTE",zip:this.config.shippo.fromZip,country:this.config.shippo.fromCountry},i={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",this.shippo.shipment.create({object_purpose:"QUOTE",address_from:s,address_to:i,parcel:t}).then(e=>{const t=(e,s)=>{("QUEUED"===e.object_status||"WAITING"===e.object_status)&&s<10?this.shippo.shipment.retrieve(e.object_id).then(e=>{t(e,s+1)}):this.shippo.shipment.rates(e.object_id).then(e=>{r(e)},e=>{console.error("There was an error retrieving rates : %s",e),n(e)})};t(e,0)},e=>{console.error("There was an error creating shipment: %s",e),n(e)})})}}},function(e,t){e.exports=require("shippo")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(8),i=r(55),a=r(56),c=r(57),o=r(3);e.exports=class{constructor(e){this.config=e}getCatalog({shopLink:e,productLinkTemplate:t}){var r,u,l,d,p,f;return n.default.async(function(h){for(;;)switch(h.prev=h.next){case 0:return r=new o(this.config),h.next=3,n.default.awrap(r.get());case 3:return u=h.sent,h.next=6,n.default.awrap(s({url:`https://${u.provider.shopify.domain}.myshopify.com/api/graphql`,method:"post",headers:{"X-Shopify-Storefront-Access-Token":u.provider.shopify.storefrontAccessToken},data:{query:"\n          query {\n            shop {\n              name\n              primaryDomain {\n                url\n              }\n              description\n              products(first: 250) {\n                edges {\n                  node {\n                    id\n                    handle\n                    title\n                    description\n                    onlineStoreUrl\n                    images(first: 1) {\n                      edges {\n                        node {\n                          originalSrc\n                          transformedSrc\n                        }\n                      }\n                    }\n                    productType\n                    vendor\n                    availableForSale\n                    priceRange {\n                      minVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                      maxVariantPrice {\n                        amount\n                        currencyCode\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        "}}));case 6:return l=h.sent.data.data,d=a.compile(t),p=l.shop.products.edges.map(e=>({"g:id":e.node.handle,"g:title":i.encode(e.node.title),"g:description":i.encode(e.node.description),"g:link":d({handle:e.node.handle}),"g:image_link":e.node.images.edges[0].node.originalSrc,"g:brand":e.node.vendor,"g:condition":"new","g:availability":e.node.availableForSale?"in stock":"out of stock","g:price":`${e.node.priceRange.minVariantPrice.amount} ${e.node.priceRange.minVariantPrice.currencyCode}`})),f=[{name:"title",text:l.shop.name},{name:"link",text:e},{name:"description",text:l.shop.description}],p.forEach(e=>{f.push({name:"item",children:e})}),h.abrupt("return",`<?xml version="1.0"?>\n    <rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">\n      ${c({channel:f})}\n    </rss>`);case 12:case"end":return h.stop()}},null,this)}}},function(e,t){e.exports=require("he")},function(e,t){e.exports=require("handlebars")},function(e,t){e.exports=require("jsontoxml")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(59),a=r(5),c=r(60),o=r(3),u=r(13),l=r(4),d=r(6);e.exports=class{constructor(e){this.config=e,this.stripe=i(this.config.stripe.apiKey),this.email=new u(this.config),this.hashids=new c(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}getSettings(){var e,t,r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return e=new o(this.config),s.next=3,n.default.awrap(e.get());case 3:t=s.sent,s.prev=4,r=t.module.ecommerce,s.next=11;break;case 8:throw s.prev=8,s.t0=s.catch(4),new Error(s.t0);case 11:s.prev=11,r.clientStripeAccountId=t.provider.stripe.stripe_user_id,s.next=18;break;case 15:throw s.prev=15,s.t1=s.catch(11),new Error(s.t1);case 18:return r.client=t.client,r.assets=t.assets,s.abrupt("return",r);case 21:case"end":return s.stop()}},null,this,[[4,8],[11,15]])}checkout(e,t){return new a((r,n)=>{this.getSettings().then(i=>{const a=s.get(i,"createsend.checkoutSubscriberListId");t.subscribe&&a&&this.email.subscribe(t.customerDetails,"createsend",a).then(e=>{console.log(e)},e=>{console.error(e)}),this.findOrCreateCustomer(t.customerDetails.email,t).then(s=>{this.createOrder(t,s).then(t=>{this.updateOrCreateStripeCustomer(i.clientStripeAccountId,s,e,t).then(e=>{this.updateCustomer(s,e,t).then(s=>{this.createCharge(i,e,s,t).then(e=>{this.sendReceipt(i,s,t).then(a=>{e.messages.orderReceipt=a,this.sendNotification(i,s,t).then(t=>{e.messages.orderNotification=t,this.updateOrder(e).then(e=>{r(e)},n)},n)},n)},n)},n)},n)},n)},n)},n).catch(n)})}retrieveAccount(){return new a((e,t)=>{this.getSettings().then(r=>{this.stripe.accounts.retrieve(r.clientStripeAccountId).then(e,t)},t)})}refund(e,t){return new a((r,n)=>{this.getSettings().then(s=>{this.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:s.clientStripeAccountId}).then(t=>{this.stripe.charges.retrieve(e.charge.id,{stripe_account:s.clientStripeAccountId}).then(t=>{e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,d.createOrUpdate(this.config,e).then(r,n)},n)},n)},n)})}findOrCreateCustomer(e,t){return new a((r,n)=>{l.connect(this.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(e=>{if(e.rows.length)r(e.rows[0].doc);else{const e=JSON.stringify(new Date).replace(/"/g,""),s={type:"customer",createdAt:e,modifiedAt:e,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};l.connect(this.config).insert(s).then(e=>{s._id=e.id,s._rev=e.rev,r(s)},n)}},n)})}updateOrCreateStripeCustomer(e,t,r,n){return new a((s,i)=>{const a={source:r,email:n.customer.email,description:n.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?this.stripe.customers.update(t.stripe.customer.id,a,{stripe_account:e}).then(s,t=>{"StripeInvalidRequestError"===t.type&&"id"===t.param?this.stripe.customers.create(a,{stripe_account:e}).then(s,i):i(t)}):this.stripe.customers.create(a,{stripe_account:e}).then(s,i)})}createOrder(e,t){return new a((r,n)=>{const s=e.items.map(e=>({id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}})),i=JSON.stringify(new Date).replace(/"/g,""),a={type:"order",orderId:this.hashids.encode((new Date).getTime()),createdAt:i,modifiedAt:i,customer:{id:t._id,email:t.email,name:t.name},items:s,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};l.connect(this.config).insert(a).then(e=>{a._id=e.id,a._rev=e.rev,r(a)},n)})}updateOrder(e){return new a((t,r)=>{l.connect(this.config).insert(e).then(r=>{e._rev=r.rev,t(e)},r)})}updateCustomer(e,t,r){return new a((n,s)=>{const i=JSON.stringify(new Date).replace(/"/g,"");e.modifiedAt=i,e.orders||(e.orders=[]),e.orders.push(r._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,l.connect(this.config).insert(e).then(t=>{e._rev=t.rev,n(e)},s)})}createCharge(e,t,r,n){return new a((i,a)=>{const c=100*Number(n.total),o={amount:c,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:n.orderId,metadata:{customer_id:r._id,order_id:n._id},statement_descriptor:s.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*c)};this.stripe.charges.create(o,{stripe_account:e.clientStripeAccountId}).then(e=>{n.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},n.test=!e.livemode,i(n)},a)})}sendReceipt(e,t,r){return new a((n,i)=>{const a={settings:e,order:r},c={from:`${e.emailSenderName} <${e.emailSenderAddress}>`,to:t.email,subject:`Your order at ${e.storeName} (${r.orderId})`},o=s.get(e,"assets.slug",this.config.slug);this.email.sendEmail(c,`${o}/order-receipt`,a).then(n,i)})}sendNotification(e,t,r){return new a((t,n)=>{const i={settings:e,order:r},a={from:`${e.emailSenderName} <${e.emailSenderAddress}>`,to:e.emailSenderAddress,subject:`New order at ${e.storeName} (${r.orderId})`},c=s.get(e,"assets.slug",this.config.slug);this.email.sendEmail(a,`${c}/order-notification`,i).then(t,n)})}}},function(e,t){e.exports=require("stripe")},function(e,t){e.exports=require("hashids")},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(4),a=r(3);e.exports=class{constructor(e){this.config=e}create(e){var t,r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return t=new a(this.config),s.next=3,n.default.awrap(t.get());case 3:return(r=s.sent).taxonomies.push(e),s.abrupt("return",t.set(r));case 6:case"end":return s.stop()}},null,this)}read(e){var t,r,i;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,i=s.find(r.taxonomies,{slug:e})){c.next=7;break}throw Error(`Taxonomy not found: ${e}`);case 7:return c.abrupt("return",i);case 8:case"end":return c.stop()}},null,this)}update(e){var t,r,i;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new a(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(i=s.findIndex(r.taxonomies,{slug:e.slug}))){c.next=7;break}throw Error(`Taxonomy not found: ${e.slug}`);case 7:return r.taxonomies.splice(i,1,e),c.abrupt("return",t.set(r));case 9:case"end":return c.stop()}},null,this)}delete(e){var t,r;return n.default.async(function(i){for(;;)switch(i.prev=i.next){case 0:return t=new a(this.config),i.next=3,n.default.awrap(t.get());case 3:return r=i.sent,e=s.isArray(e)?e:[e],r.taxonomies=r.taxonomies.filter(t=>-1===e.indexOf(t.slug)),i.abrupt("return",t.set(r));case 7:case"end":return i.stop()}},null,this)}entitiesByTerm(e){var t,r,a,c;return n.default.async(function(o){for(;;)switch(o.prev=o.next){case 0:return t=i.connect(this.config),o.next=3,n.default.awrap(t.view("entity","byTaxonomyTerm",{keys:[e.id],group:!0}));case 3:if(o.t0=(e=>e.value),r=o.sent.rows.map(o.t0)[0]){o.next=7;break}return o.abrupt("return",[]);case 7:return a=[],s.forEach(r,e=>{a=a.concat(e)}),a=s.uniq(a),o.next=12,n.default.awrap(t.fetch({keys:a,include_docs:!0}));case 12:return o.t1=(e=>e.doc),o.t2=(e=>e.doc),c=o.sent.rows.filter(o.t1).map(o.t2),o.abrupt("return",c);case 16:case"end":return o.stop()}},null,this)}createTerm(e,t){var r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,n.default.awrap(this.read(e));case 2:return(r=s.sent).terms.push(t),s.abrupt("return",this.update(r));case 5:case"end":return s.stop()}},null,this)}updateTerm(e){var t;return n.default.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.default.awrap(this.entitiesByTerm(e));case 2:return t=(t=r.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t.parents||(t.parents=[]),t.parents=t.parents.map(t=>(t.id===e.id&&(t.title=e.title,t.slug=e.slug),t)),t))),t)),t)),r.abrupt("return",i.connect(this.config).bulk({docs:t}));case 5:case"end":return r.stop()}},null,this)}deleteTerm(e){var t;return n.default.async(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.default.awrap(this.entitiesByTerm(e));case 2:return t=(t=r.sent).map(t=>(t.fields=s.mapValues(t.fields,t=>("taxonomy"===t.type&&t.value&&(t.value.terms||(t.value.terms=[]),t.value.terms=t.value.terms.filter(t=>t.id!==e.id&&!(t.parents||[]).filter(t=>t.id===e.id).length)),t)),t)),r.abrupt("return",i.connect(this.config).bulk({docs:t}));case 5:case"end":return r.stop()}},null,this)}}},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(5).promisifyAll(r(9)),i=r(11),a=r(4);e.exports=class{constructor(e){this.config=e}getDb(){var e;return n.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.default.awrap(a.connect(this.config).fetch({include_docs:!0}));case 2:return e=t.sent,t.abrupt("return",e);case 4:case"end":return t.stop()}},null,this)}getChanges(){var e;return n.default.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.default.awrap(a.connect(this.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"}));case 2:return e=t.sent,t.abrupt("return",e);case 4:case"end":return t.stop()}},null,this)}importDb(e){var t,r,c,o,u;return n.default.async(function(l){for(;;)switch(l.prev=l.next){case 0:return t=this.config.db.name,l.next=3,n.default.awrap(s.readFileAsync(e.path));case 3:return r=l.sent,c=JSON.parse(r).rows.map(e=>{const{doc:t}=e;return delete t._rev,t}),l.next=7,n.default.awrap(s.unlinkAsync(e.path));case 7:return o=new i({url:this.config.db.url,plugins:["promises","retry"]}).db,l.prev=8,l.next=11,n.default.awrap(o.destroy(t));case 11:l.next=15;break;case 13:l.prev=13,l.t0=l.catch(8);case 15:return l.next=17,n.default.awrap(o.create(t));case 17:return l.next=19,n.default.awrap(a.connect(this.config,t).bulk({docs:c}));case 19:return u=l.sent,l.abrupt("return",u);case 21:case"end":return l.stop()}},null,this,[[8,13]])}}},function(e,t,r){"use strict";var n=r(1)(r(2));const s=r(0),i=r(3);e.exports=class{constructor(e){return this.config=e,this}create(e){var t,r;return n.default.async(function(s){for(;;)switch(s.prev=s.next){case 0:return t=new i(this.config),s.next=3,n.default.awrap(t.get());case 3:return(r=s.sent).users.push(e),s.abrupt("return",t.set(r));case 6:case"end":return s.stop()}},null,this)}read(e){var t,r,a;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,a=s.find(r.users,{id:e})){c.next=7;break}throw Error(`User not found: ${e}`);case 7:return c.abrupt("return",a);case 8:case"end":return c.stop()}},null,this)}update(e){var t,r,a;return n.default.async(function(c){for(;;)switch(c.prev=c.next){case 0:return t=new i(this.config),c.next=3,n.default.awrap(t.get());case 3:if(r=c.sent,-1!==(a=s.findIndex(r.users,{id:e.id}))){c.next=7;break}throw Error(`User not found: ${e.id}`);case 7:return r.users.splice(a,1,e),c.abrupt("return",t.set(r));case 9:case"end":return c.stop()}},null,this)}delete(e){var t,r;return n.default.async(function(a){for(;;)switch(a.prev=a.next){case 0:return t=new i(this.config),a.next=3,n.default.awrap(t.get());case 3:return r=a.sent,e=s.isArray(e)?e:[e],r.users=r.users.filter(t=>-1===e.indexOf(t.id)),a.abrupt("return",t.set(r));case 7:case"end":return a.stop()}},null,this)}}}])});
//# sourceMappingURL=api.js.map