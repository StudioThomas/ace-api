!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApiServer=t():e.AceApiServer=t()}(global,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=103)}([function(e,t){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("babel-runtime/regenerator")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("babel-runtime/helpers/createClass")},function(e,t){e.exports=require("babel-runtime/helpers/classCallCheck")},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(7),l=n(9),d={_id:"config",client:{},schemas:[],taxonomies:[],users:[],roles:(new(n(21))).roles()},f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"get",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=d,e.prev=1,e.next=4,c.connect(this.config).get("config");case 4:t=e.sent,t=o.merge({},d,t),e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:return t.slug=this.config.slug,e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this,[[1,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,s.default)(r.default.mark(function e(t){return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t._id="config",delete t.roles,e.next=4,l.createOrUpdate(this.config,t);case 4:return t=e.sent,t=o.merge({},d,t),e.abrupt("return",t);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(22),i=function(){function e(t,n){return(0,r.default)(this,e),this.config=t,e.connect(t,n)}return(0,s.default)(e,null,[{key:"connect",value:function(e,t){return new u({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}]),e}();e.exports=i},function(e,t){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(4)),a=u(n(3));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=n(6),c=n(7),l=function(){function e(t){(0,s.default)(this,e),this.config=t,this.assistUrl=t.assist.url,this.slug=t.slug}return(0,a.default)(e,[{key:"thumbnailSrc",value:function(e,t,n,r){if(!e)return"";var s=void 0;"string"==typeof t&&(s=t.split(/,|;/),t={},s.forEach(function(e){e=e.split(/_|:/),t[e[0]]=e[1]}));var a=!!e.crops&&e.crops[n];a?(t.x=a[0],t.y=a[1],t.x2=a[2],t.y2=a[3]):r&&(t.g=r),s=[],i.forEach(t,function(e,t){s.push([t,e].join(":"))});var u=s.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",u,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",u,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){var o=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",u,o].join("/")}return""}}],[{key:"createOrUpdate",value:function(e,t){return new o(function(n,r){c.connect(e).insert(t).then(function(e){t._id=e.id,t._rev=e.rev,n(t)},function(s){409===s.statusCode?c.connect(e).get(t._id).then(function(s){t._rev=s._rev,c.connect(e).insert(t).then(function(e){t._rev=e.rev,n(t)},r)},r):r(s)})})}},{key:"chunkUpdate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return new o(function(r,s){var a=[];i.chunk(t,n).forEach(function(t){a.push(new o(function(n,r){c.connect(e).bulk({docs:t}).then(n,r)}))}),o.all(a).then(r,s)})}},{key:"groupEntities",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r={entities:[]};return e.forEach(function(e){(!e.groupBefore||r.entities.length>=t)&&(r={entities:[]}),r.entities.push(e),(!e.groupAfter||r.entities.length>=t)&&(r.ratio=0,r.entities.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.entities.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n}},{key:"now",value:function(){return(0,r.default)(new Date).replace(/"/g,"")}},{key:"replace",value:function(e,t,n){return e.map(function(e){return e[n]===t[n]?t:e})}}]),e}();e.exports=l},function(e,t){e.exports=require("babel-runtime/core-js/object/keys")},function(e,t){e.exports=require("lodash/isArray")},function(e,t,n){"use strict";var r={environment:process.env.ENVIRONMENT||"development",api:{prefix:process.env.API_PREFIX||"",blacklistToken:(process.env.API_BLACKLIST_TOKEN||"").split(","),blacklistReferrer:(process.env.API_BLACKLIST_REFERRER||"").split(",")},forceHttps:!!process.env.FORCE_HTTPS&&JSON.parse(process.env.FORCE_HTTPS),session:{secret:process.env.SESSION_SECRET||"change_me",ttl:parseInt(process.env.SESSION_TTL||7200,10)},cache:{enabled:!!process.env.CACHE_ENABLED&&JSON.parse(process.env.CACHE_ENABLED),ttl:60*parseInt(process.env.CACHE_TTL||30,10),compress:!!process.env.CACHE_COMPRESS&&JSON.parse(process.env.CACHE_COMPRESS),memory:{max:1e3*parseInt(process.env.CACHE_MEMORY_MAX||128,10)*1e3}},redis:{url:process.env.REDIS_URL,host:process.env.REDIS_HOST,port:process.env.REDIS_PORT,password:process.env.REDIS_PASSWORD,db:parseInt(process.env.REDIS_DB||0,10)},logentriesToken:process.env.LOGENTRIES_TOKEN};e.exports=r},function(e,t){e.exports=require("babel-runtime/helpers/typeof")},function(e,t){e.exports=require("request-promise")},function(e,t,n){"use strict";var r=u(n(20)),s=u(n(4)),a=u(n(3));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}],c=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,null,[{key:"fields",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"field",value:function(t){return i.find(e.fields(),{type:t})}}]),e}();e.exports=c},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=n(7),d=n(15),f=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).schemas.push(t),e.next=7,this.updateEntityIndex(s.schemas);case 7:return e.abrupt("return",n.set(s));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.schemas,{slug:t})){e.next=7;break}throw Error("Schema not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.schemas,{slug:t.slug}))){e.next=7;break}throw Error("Schema not found: "+t.slug);case 7:return s.schemas.splice(a,1,t),e.next=10,this.updateEntityIndex(s.schemas);case 10:return e.abrupt("return",n.set(s));case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.schemas=s.schemas.filter(function(e){return-1===t.indexOf(e.slug)}),s.schemas=s.schemas.map(function(e){return e.fields?(e.fields=e.fields.map(function(e){return e.settings?(e.settings.schemas&&(e.settings.schemas=e.settings.schemas.filter(function(e){return-1===t.indexOf(e)})),e):e}),e):e}),e.next=9,this.updateEntityIndex(s.schemas);case 9:return e.abrupt("return",n.set(s));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateAll",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).schemas=t,e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateEntityIndex",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],t.forEach(function(e){n=n.concat(e.fields)}),n=o.uniqBy(n,"slug"),s={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},n.forEach(function(e){var t=d.field(e.type);/number|string|boolean/.test(t.dataType)&&s.index.fields.push({name:"fields."+e.slug+".value",type:t.dataType}),/array/.test(t.dataType)&&s.index.fields.push({name:"fields."+e.slug+".value.[].slug",type:"string"}),/taxonomy/.test(e.type)&&s.index.fields.push({name:"fields."+e.slug+".value.terms.[].slug",type:"string"})}),e.next=7,l.connect(this.config).index(s);case 7:return a=e.sent,e.abrupt("return",a);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t,n){"use strict";var r=o(n(8)),s=o(n(1)),a=o(n(0)),u=o(n(4)),i=o(n(3));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(6),d=n(63),f=n(62).diff,p=n(5),h=n(7),v=n(9),m=n(16),y=n(24),g=function(){function e(t){(0,u.default)(this,e),this.config=t,this.flattenValues=e.flattenValues}return(0,i.default)(e,[{key:"fieldValues",value:function(){var e=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.connect(this.config).viewWithList("entity","byField","search",{startkey:[t],endkey:[t,{}],group:!0,searchTerm:n});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_entitiesById",value:function(){var t=(0,a.default)(s.default.mark(function t(){var n,r,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"guest";return s.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={include_docs:!0},a.length&&(n.keys=a),t.next=4,h.connect(this.config).view("entity",u?"byIdExtended":"byId",n);case 4:return r=t.sent,r=e._appendParents(r,u,i),t.abrupt("return",r);case 7:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_getDocMap",value:function(){var t=(0,a.default)(s.default.mark(function t(n,r,a,u){var i,o,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return s.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a||r){t.next=2;break}return t.abrupt("return",l);case 2:if(i=[],n.forEach(function(t){var n=!!t.doc,s=n?t.doc:t;r&&s.fields&&c.size(s.fields)&&(c.isArray(r)?r[d].split(/,(?![^([]*[\])])/g).forEach(function(t){i=i.concat(c.flatten(e._query(s,t,!0).value).map(function(e){return e&&e.id}))}):c.forEach(s.fields,function(e){c.isArray(e.value)&&(e.value=e.value.filter(function(e){return e}),e.value.forEach(function(e){e.id&&i.push(e.id)}))}));var a=n?t.id:s._id||s.id;l[a]||i.push(a)}),0!==(i=(i=c.uniq(i)).filter(function(e){return!l[e]})).length){t.next=8;break}return t.abrupt("return",l);case 8:return t.next=10,this._entitiesById(i,a,u);case 10:if(t.t0=function(e){return e.doc},(o=t.sent.rows.map(t.t0)).forEach(function(e){l[e._id]=e}),d+=1,r&&!(d>=e._childDepthLimit(r))){t.next=16;break}return t.abrupt("return",l);case 16:return t.next=18,this._getDocMap(o,r,a,u,l,d);case 18:return l=t.sent,o=null,t.abrupt("return",l);case 21:case"end":return t.stop()}},t,this)}));return function(e,n,r,s){return t.apply(this,arguments)}}()},{key:"_extendDocs",value:function(){var t=(0,a.default)(s.default.mark(function t(n,r,a,u){var i;return s.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getDocMap(n,r,a,u);case 2:return i=t.sent,n=e._mergeDocs(n,i,r),i=null,t.abrupt("return",n);case 6:case"end":return t.stop()}},t,this)}));return function(e,n,r,s){return t.apply(this,arguments)}}()},{key:"_removeChildren",value:function(e){var t=this;return new l(function(n,r){0!==e.length?(e=e.map(function(e){return e._id}),h.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(s){var a=c.uniqBy(s.rows,function(e){return e.doc._id}).map(function(t){return t.doc.fields=c.mapValues(t.doc.fields,function(t){return c.isArray(t.value)&&(t.value=c.remove(t.value,function(t){return"entity"===t.type&&-1!==e.indexOf(t.id)})),t}),t.doc});0!==a.length?v.chunkUpdate(t.config,a,1e3).then(n,r):n([])},r)):n([])})}},{key:"_updateChildren",value:function(e){var t=this;return new l(function(n,r){if(0!==e.length){var s={};e=e.map(function(e){return s[e._id]=e,e._id}),h.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(e){var a=e.rows.map(function(e){var t=e.doc;return c.forEach(t.fields,function(e,n){c.isArray(e.value)&&(t.fields[n].value=e.value.map(function(e){return"entity"===e.type&&s[e.id]&&(e.slug=s[e.id].slug,e.title=s[e.id].title,e.schema=s[e.id].schema,e.published=s[e.id].published,s[e.id].thumbnail?e.thumbnail=s[e.id].thumbnail:e.thumbnail=null),e}))}),t});v.chunkUpdate(t.config,a,1e3).then(n,r)},r)}else n([])})}},{key:"entityList",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._entitiesById(r,u,i);case 2:if(t=e.sent,(a||u)&&0!==t.total_rows){e.next=5;break}return e.abrupt("return",t.rows);case 5:return e.next=7,this._extendDocs(t.rows,a,u,i);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(u,i){e.limit=Math.min(e.limit||200,200),e.sort=c.isString(e.sort)?'"'+e.sort+'"':e.sort,t&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),c.isArray(e.include_fields)&&(e.include_fields=(0,r.default)(e.include_fields)),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,h.connect(n.config).search("entity",e.index||"all",e).then(function(e){if(e.groups){var r=[];return e.groups=e.groups.map(function(e){return r.push(new l(function(r,u){(t||s)&&0!==e.total_rows?n._extendDocs(e.hits,t,s,a).then(function(t){e.hits=t,r()},u):r()})),e}),void l.all(r).then(function(){u(e)},i)}(t||s)&&0!==e.total_rows?n._extendDocs(e.rows,t,s,a).then(function(t){e.rows=t,u(e)},i):u(e)},i)})}},{key:"entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(a,u){var i=e.limit||25;if(i<=200)n._entitySearch(e,t,r,s).then(a,u);else{var o=[],l=[];(function n(d){var f=this,p=c.clone(e);d&&(p.bookmark=d),this._entitySearch(p,t,r,s).then(function(e){e.rows&&(o=o.concat(e.rows)),e.groups&&(l=l.concat(e.groups)),o.length<e.total_rows&&o.length<i?n.call(f,e.bookmark):(e.rows=o,e.groups=l,a(e))},u)}).call(n)}})}},{key:"entityFind",value:function(){var e=(0,a.default)(s.default.mark(function e(t){var n,r,a,u,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0,e.prev=1,e.next=4,h.connect(this.config).find(t);case 4:n=e.sent,e.next=20;break;case 7:if(e.prev=7,e.t0=e.catch(1),"no_usable_index"!==e.t0.error){e.next=20;break}return r=new p(this.config),e.next=13,r.get();case 13:return a=e.sent,u=new m(this.config),e.next=17,u.updateEntityIndex(a.schemas);case 17:return e.next=19,h.connect(this.config).find(t);case 19:n=e.sent;case 20:if(!1!==i){e.next=22;break}return e.abrupt("return",n);case 22:if(!t.fields||-1!==t.fields.indexOf("_id")){e.next=24;break}throw new Error("_id field required for `children`");case 24:return e.next=26,this._extendDocs(n.docs,i,o,c);case 26:return n.docs=e.sent,e.abrupt("return",n);case 28:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t){return e.apply(this,arguments)}}()},{key:"entityRevisions",value:function(t){var n=this;return new l(function(s,a){h.connect(n.config).get(t,{revs_info:!0}).then(function(u){var i=[];u._revs_info.forEach(function(e){"available"===e.status&&i.push(e.rev)}),h.connect(n.config).get(t,{open_revs:(0,r.default)(i)}).then(function(t){var r=[],u=[];t.forEach(function(e){e.ok&&(r.push(e.ok),c.forEach(e.ok.fields,function(e){/entity/.test(e.type)&&c.forEach(e.value,function(e){e.id&&u.push(e.id)})}))}),h.connect(n.config).fetch({keys:c.uniq(u),include_docs:!0}).then(function(t){var n={};t.rows.forEach(function(e){try{n[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),s(e._appendChildren(r,n))},a)},a)},a)})}},{key:"entityCreate",value:function(e){var t=this;return new l(function(n,r){e.type="entity",h.connect(t.config).insert(e).then(function(t){e._id=t.id,e._rev=t.rev,n(e)},r)})}},{key:"entityRead",value:function(e){var t=this;return new l(function(n,r){h.connect(t.config).get(e).then(n,r)})}},{key:"entityUpdate",value:function(e,t){var n=this;return new l(function(r,s){var a={},u=(e=c.isArray(e)?e:[e]).map(function(e){var t=void 0;return c.isObject(e)&&(t=e._id,a[t]=e),c.isString(e)&&(t=e),t});h.connect(n.config).fetch({keys:u,include_docs:!0}).then(function(e){var i=[],o=e.rows.map(function(e){var n=e.doc,r=a[n._id],s=n;r&&(delete r._rev,f(n,r).forEach(function(e){/slug|title|thumbnail/.test(e.path[0])&&-1===i.indexOf(r)&&-1!==u.indexOf(r._id)&&i.push(r)}),s=c.mergeWith({},n,r,function(e,t){if(c.isArray(e)&&c.isArray(t))return t}));return t&&(s.trashed=!1),s});n._updateChildren(i).then(function(){v.chunkUpdate(n.config,o,1e3).then(r,s)},s)},s)})}},{key:"entityDelete",value:function(){var t=(0,a.default)(s.default.mark(function t(n){var r,a,u,i,o,l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return s.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=void 0,a=void 0,"trashed"!==n){t.next=9;break}return l=!0,t.next=6,h.connect(this.config).view("entity","trashed",{include_docs:!0});case 6:r=t.sent.rows,t.next=12;break;case 9:return t.next=11,h.connect(this.config).fetch({keys:c.isArray(n)?n:[n],include_docs:!0});case 11:r=t.sent.rows;case 12:if(r=(r=r.filter(function(e){return!e.value||!e.value.deleted})).map(function(e){return e.doc}),!l){t.next=26;break}return t.next=17,this._removeChildren(r);case 17:if(!(u=e._fileNames(r)).length){t.next=23;break}return i=new y(this.config),t.next=22,i.deleteFiles(u);case 22:a=t.sent;case 23:r=r.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),t.next=27;break;case 26:r=r.map(function(e){return e.trashed=!0,e});case 27:return t.next=29,v.chunkUpdate(this.config,r,1e3);case 29:return o=t.sent,t.abrupt("return",{entities:o,files:a});case 31:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}],[{key:"flattenValues",value:function(t){return t.map(function(t){return t.fields&&c.size(t.fields)?(t.fields=c.mapValues(t.fields,function(t){return/entity/.test(t.type)&&c.isArray(t.value)&&(t.value=e.flattenValues(t.value)),t.value}),t):t})}},{key:"filterEntityFields",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"guest",n=c.isArray(e);return e=(n?e:[e]).map(function(e){return c.size(e.fields)&&(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published))})),e})),e}),n?e:e[0]}},{key:"_appendChildren",value:function(e,t){return e.map(function(e){return c.size(e.fields)?(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&("entity"!==e.type||void 0!==t[e.id])}),e.value=e.value.map(function(e){return"entity"===e.type&&(e=c.merge(e,t[e.id])),e=c.omitBy(e,function(e,t){return t.startsWith("_")})})),e}),e):e})}},{key:"_appendParents",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"guest",s={};return t.rows.forEach(function(e){e.doc&&"entity"===e.value.type&&(n&&(e.doc.parents=[]),s[e.id]=e.doc)}),n&&(t.rows.forEach(function(t){t.doc&&"parent"===t.value.type&&s[t.key].parents.push(e.filterEntityFields(t.doc,r))}),s=c.mapValues(s,function(e){return e.parents=c.uniqBy(e.parents,function(e){return e._id}),e})),s=null,t}},{key:"_fileNames",value:function(e){var t=[];return e.forEach(function(e){c.forEach(e.fields,function(e){e.value&&e.value.file&&t.push(e.value.file.name)})}),c.uniq(t)}},{key:"_query",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.trim().split(/\[|\]/),s="fields."+r[0]+".value["+(r[1]||"*")+"]",a=/\]:/.test(t)?":"+t.split(/\]:/).slice(-1)[0].trim():"";return d(""+s+a,{data:e,locals:{slice:function(e,t,n){return c.slice(e,t,n)},sample:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return c.sampleSize(e,t)},group:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r=[];return e.forEach(function(e){(!e.groupBefore||r.length>=t)&&(r=[]),r.push(e),(!e.groupAfter||r.length>=t)&&(r.ratio=0,r.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n},pick:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];return c.map(e,function(e){var t={};return n&&e.id&&(t.id=e.id),r.forEach(function(n){c.set(t,n,c.get(e,n))}),t})}},allowRegexp:!0})}},{key:"_childDepthLimit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return c.isNumber(e)?e:c.isArray(e)?t?e.length+1:e.length:1}},{key:"_mergeDocs",value:function(t,n,r){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return r&&s+1>=e._childDepthLimit(r,!0)?t:t=t.map(function(t){var a=!!t.doc,u=a?t.doc:t;if(!u.fields&&n[t.id||t._id]&&(u=n[t.id||t._id]),r&&u.fields&&c.size(u.fields)){var i=void 0;c.isArray(r)&&(i={},r[s].split(/,(?![^([]*[\])])/g).forEach(function(e){var t=(e=e.trim()).split(/\[|\]/)[0];i[t]=e})),u.fields=c.mapValues(u.fields,function(t,a){return c.isArray(t.value)&&(t.value=t.value.filter(function(e){return e}),(!i||i&&i[a])&&(i&&i[a]&&(t.value=t.value.filter(function(e){return e.id&&n[e.id]})),t.value=t.value.map(function(e){return e&&e.id&&n[e.id]&&(e=c.merge(e,n[e.id]||{}),e=c.omitBy(e,function(e,t){return t.startsWith("_")})),e}),t.value=e._mergeDocs(t.value,n,r,s+1))),t}),u.fields=c.mapValues(u.fields,function(t,n){return c.isArray(t.value)&&i&&i[n]&&(t.value=c.flatten(e._query(u,i[n]).value)),t})}return a?t.doc=u:t=u,t})}}]),e}();e.exports=g},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(25),i=n(18),o=n(2),c=n(6),l=n(78),d=c.promisifyAll(n(77)),f=n(76),p=n(75),h=n(74).Inky,v=n(73),m=n(72).registerComponent,y=n(71).registerDependencies,g=n(70),x=g.McSection,b=g.McImage,w=n(69),k=n(68),_=n(67),E=n(66),S=n(5),T=n(9),A=function(){function e(t){(0,r.default)(this,e),this.config=t,this.inky=new h,m(x),m(b),y({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}return(0,s.default)(e,[{key:"getTemplate",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new c(function(s,a){r=o.merge({},{preview:!1,inky:!1,mjml:!1,skipValidation:!1},r);var c=u.resolve(n.config.email.templatesPath,e),l="pug";i.existsSync(c+"/html.ejs")&&(l="ejs");var d=E.renderSync({file:u.resolve(c,"style.scss"),sourceMapContents:r.preview,sourceMapEmbed:r.preview}).css.toString().replace(/"/g,"'"),f=new p({views:{root:n.config.email.templatesPath,options:{extension:l}},juice:!r.preview,juiceResources:{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}},transport:{jsonTransport:!0}}),h=new S(n.config),m=new T(n.config);h.get().then(function(u){t=o.merge({},t,{config:o.pick(u,["client","assets"]),helpers:m,style:d,moment:k,countries:_,template:e,preview:r.preview}),f.render(e+"/html",t).then(function(e){if(r.mjml){var t=v(e,{level:r.skipValidation?"skip":"soft"});if(t.errors&&t.errors.length)return void a(t.errors);e=t.html}r.inky&&(e=n.inky.releaseTheKraken(e)),s({html:e,text:w.fromString(e)})},a)},a)})}},{key:"sendEmail",value:function(e,t,n,r){var s=this;return new c(function(a,u){var i=l.createTransport(f({auth:{api_key:s.config.mailgun.apiKey,domain:s.config.mailgun.domain}}));s.getTemplate(t,n,r).then(function(t){e.html=t.html,e.text=t.text,i.sendMail(e,function(t,n){t?u(t):a({metadata:n,email:e})})},u)})}},{key:"subscribe",value:function(e,t,n){var r=this;return new c(function(s,a){new S(r.config).get().then(function(r){if("createsend"===t){if(r.provider.createsend){var u=new d({apiKey:r.provider.createsend.clientApiKey});return void c.promisifyAll(u.subscribers).addSubscriberAsync(n,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(function(e){s("Email.subscribe(): "+e.emailAddress)}).catch(function(e){a(e.Message)})}a(new Error("Subscriber list not configured"))}},a)})}}]),e}();e.exports=A},function(e,t){e.exports=require("babel-runtime/core-js/object/freeze")},function(e,t,n){"use strict";var r=u(n(20)),s=u(n(4)),a=u(n(3));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2),o=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}}],c=function(){function e(){(0,s.default)(this,e)}return(0,a.default)(e,[{key:"roles",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"role",value:function(e){return i.find(this.roles(),{slug:e})}}]),e}();e.exports=c},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t){e.exports=require("axios")},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(23),l=n(82),d=n(5),f=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"deleteFiles",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new d(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.get(s,"assets.slug",this.config.slug),0!==t.length){e.next=7;break}return e.abrupt("return",[]);case 7:return e.next=9,c.post(this.config.assist.url+"/"+a+"/file/delete",{fileNames:t},{auth:{username:this.config.assist.username,password:l.generate(this.config.assist.password)}});case 9:return u=e.sent.data,e.abrupt("return",u);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a,u,i=e.User,o=e.router,c=e.authMiddleware,l=e.permissionMiddleware,d=e.asyncMiddleware,f=e.getConfig,p=e.handleResponse,h=e.handleError;o.post("/user.:ext?",c,l.bind(null,"user"),d((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,f(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=p,e.t3=t,e.t4=n,e.next=11,s.create(t.body.user);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),h(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)}))),o.get("/user.:ext?",c,l.bind(null,"user"),d((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,f(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=p,e.t3=t,e.t4=n,e.next=11,s.read(t.query.userId);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),h(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)}))),o.put("/user.:ext?",c,l.bind(null,"user"),d((a=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,f(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=p,e.t3=t,e.t4=n,e.next=11,s.update(t.body.user);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),h(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return a.apply(this,arguments)}))),o.delete("/user.:ext?",c,l.bind(null,"user"),d((u=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,f(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=p,e.t3=t,e.t4=n,e.next=11,s.delete(t.body.userId||t.body.userIds||t.query.userId||t.query.userIds);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),h(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return u.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a=e.Tools,u=e.router,i=e.authMiddleware,o=e.permissionMiddleware,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError;u.get("/tools/export-db.:ext?",i,o.bind(null,"tools"),c((t=(0,s.default)(r.default.mark(function e(t,n){var s,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=a,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.next=8,s.getDb();case 8:u=e.sent,n.setHeader("Content-Disposition","attachment; filename="+t.session.slug+".json"),n.setHeader("Content-Type","application/json"),n.status(200),n.send(u),e.next=18;break;case 15:e.prev=15,e.t2=e.catch(5),f(t,n,e.t2);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)}))),u.get("/tools/changes.:ext?",i,c((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=a,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=t,e.t4=n,e.next=11,s.getChanges();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,a=e.Jwt,u=e.router,i=e.authMiddleware,o=e.asyncMiddleware,c=e.getConfig,l=e.handleResponse;u.get("/token.:ext?",i,o((t=(0,s.default)(r.default.mark(function e(t,s){var u,i,o,d,f,p;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c();case 2:u=e.sent,i={role:t.session.role,slug:t.session.slug,userId:t.session.userId},"super"!==t.session.role&&"development"!==u.environment||(i.role=t.query.role||t.session.role||u.dev.role,i.slug=t.query.slug||t.session.slug||u.dev.slug,"guest"!==i.role&&(i.userId=t.query.userId||t.session.userId||u.dev.userId)),o=n(2),d=o.pickBy(t.query,function(e,t){return/^(expiresIn|notBefore|audience|issuer|jwtid|subject|noTimestamp|header)$/.test(t)}),d=o.mapValues(d,function(e){return o.isNaN(+e)?e:+e}),f=a(u),p=f.signToken(i,d),t.session.apiToken=p,l(t,s,{token:p,payload:i,options:d});case 13:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a,u,i,o,c,l=e.Taxonomy,d=e.router,f=e.authMiddleware,p=e.permissionMiddleware,h=e.cacheMiddleware,v=e.asyncMiddleware,m=e.getConfig,y=e.handleResponse,g=e.handleError;d.post("/taxonomy.:ext?",f,p.bind(null,"taxonomyUpdate"),v((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.create(t.body.taxonomy);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)}))),d.get("/taxonomy.:ext?",h,v((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.read(t.query.slug||t.query.taxonomySlug);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)}))),d.put("/taxonomy.:ext?",f,p.bind(null,"taxonomyUpdate"),v((a=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.update(t.body.taxonomy);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return a.apply(this,arguments)}))),d.delete("/taxonomy.:ext?",f,p.bind(null,"taxonomyUpdate"),v((u=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.delete(t.body.taxonomySlug||t.body.taxonomySlugs||t.query.taxonomySlug||t.query.taxonomySlugs);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return u.apply(this,arguments)}))),d.post("/taxonomy/term.:ext?",f,p.bind(null,"taxonomyUpdate"),v((i=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.createTerm(t.body.slug||t.body.taxonomySlug,t.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return i.apply(this,arguments)}))),d.put("/taxonomy/term.:ext?",f,p.bind(null,"taxonomyUpdate"),v((o=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.updateTerm(t.query.term||t.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return o.apply(this,arguments)}))),d.delete("/taxonomy/term.:ext?",f,p.bind(null,"taxonomyUpdate"),v((c=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,m(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=y,e.t3=t,e.t4=n,e.next=11,s.deleteTerm(t.query.term||t.body.term);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),g(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return c.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a,u,i=e.Ecommerce,o=e.Email,c=e.Stripe,l=e.router,d=e.authMiddleware,f=e.permissionMiddleware,p=e.asyncMiddleware,h=e.getConfig,v=e.handleResponse,m=e.handleError;l.all("/stripe/checkout.:ext?",p((t=(0,s.default)(r.default.mark(function e(t,n){var s,a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.token||JSON.parse(t.query.token),a=t.body.order||JSON.parse(t.query.order),e.t0=c,e.next=5,h(t.session.slug);case 5:return e.t1=e.sent,u=(0,e.t0)(e.t1),e.prev=7,e.t2=v,e.t3=t,e.t4=n,e.next=13,u.checkout(s,a);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),m(t,n,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])})),function(e,n){return t.apply(this,arguments)}))),l.post("/stripe/refund.:ext?",d,f.bind(null,"ecommerce"),p((n=(0,s.default)(r.default.mark(function e(t,n){var s,a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.body.order||JSON.parse(t.query.order),a=100*Number(t.body.amount||t.query.amount||0),e.t0=c,e.next=5,h(t.session.slug);case 5:return e.t1=e.sent,u=(0,e.t0)(e.t1),e.prev=7,e.t2=v,e.t3=t,e.t4=n,e.next=13,u.refund(s,a);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),m(t,n,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])})),function(e,t){return n.apply(this,arguments)}))),l.get("/stripe/account.:ext?",d,f.bind(null,"ecommerce"),p((a=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=c,e.next=3,h(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=v,e.t3=t,e.t4=n,e.next=11,s.retrieveAccount();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),m(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return a.apply(this,arguments)}))),l.get("/stripe/email.:ext?",p((u=(0,s.default)(r.default.mark(function e(t,n){var s,a,u,l,d,f,p,y;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h(t.session.slug);case 2:return s=e.sent,a=o(s),u=c(s),l=i(s),e.next=8,u.getSettings();case 8:return d=e.sent,e.next=11,l.getOrder(t.query.orderId);case 11:return f=e.sent,p={settings:d,order:f},e.next=15,a.getTemplate(t.session.slug+"/"+t.query.template,p);case 15:y=e.sent;try{v(t,n,y.html)}catch(e){m(t,n,e)}case 17:case"end":return e.stop()}},e,void 0)})),function(e,t){return u.apply(this,arguments)})))}},function(e,t){e.exports=require("twitter")},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,a,u=e.ClientConfig,i=e.Instagram,o=e.router,c=e.cacheMiddleware,l=e.asyncMiddleware,d=e.getConfig,f=e.handleResponse,p=e.handleError,h={};o.get(/\/social\/twitter\/([^/]+)\/?(.+)?/,c,l((t=(0,s.default)(r.default.mark(function e(t,s){var a,u,i,o,c,l;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.params[0],u=t.params[1].split("/").filter(function(e){return""!==e}),e.next=4,d(t.session.slug);case 4:return i=e.sent,o=n(6),c=n(32),l=o.promisifyAll(new c({consumer_key:i.twitter.consumerKey,consumer_secret:i.twitter.consumerSecret,access_token_key:i.twitter.accessTokenKey,access_token_secret:i.twitter.accessTokenSecret})),e.prev=8,e.t0=f,e.t1=t,e.t2=s,e.next=14,l[a+"Async"](u.join("/"),t.query);case 14:e.t3=e.sent,(0,e.t0)(e.t1,e.t2,e.t3,!0),e.next=21;break;case 18:e.prev=18,e.t4=e.catch(8),p(t,s,e.t4);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])})),function(e,n){return t.apply(this,arguments)}))),o.get(/\/social\/instagram\/([^/]+)\/?(.+)?/,c,l((a=(0,s.default)(r.default.mark(function e(t,n){var s,a,o,c,l,v,m;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=t.params[0],a=t.params[1].split("/").filter(function(e){return""!==e}),e.next=4,d(t.session.slug);case 4:if(o=e.sent,h[t.session.slug]){e.next=18;break}return c=u(o),e.prev=7,e.next=10,c.get();case 10:l=e.sent,h[t.session.slug]=l.provider.instagram.access_token,e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(7),p(n,new Error("Instagram: access_token required")),e.abrupt("return");case 18:return t.query.access_token=h[t.session.slug],v=i({client_id:o.instagram.clientId}),e.prev=20,e.next=23,v[s](a.join("/"),t.query);case 23:m=e.sent;try{delete m.pagination.next_url}catch(e){}f(t,n,m,!0),e.next=31;break;case 28:e.prev=28,e.t1=e.catch(20),p(t,n,e.t1);case 31:case"end":return e.stop()}},e,void 0,[[7,14],[20,28]])})),function(e,t){return a.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.Shippo,a=e.router,u=e.asyncMiddleware,i=e.getConfig,o=e.handleResponse,c=e.handleError;a.all("/shippo/quote.:ext?",u((t=(0,s.default)(r.default.mark(function e(t,s){var a,u,l;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,i();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),u=t.body.address||JSON.parse(t.params.address),l=t.body.parcel||JSON.parse(t.params.parcel),e.prev=7,e.t2=o,e.t3=t,e.t4=s,e.next=13,a.getQuote(u,l);case 13:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=20;break;case 17:e.prev=17,e.t6=e.catch(7),c(t,s,e.t6);case 20:case"end":return e.stop()}},e,void 0,[[7,17]])})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.Settings,a=e.router,u=e.authMiddleware,i=e.permissionMiddleware,o=e.asyncMiddleware,c=e.getConfig,l=e.handleResponse,d=e.handleError;a.post("/settings.:ext?",u,i.bind(null,"settings"),o((t=(0,s.default)(r.default.mark(function e(t,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,c(t.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=t,e.t4=s,e.next=11,a.update(t.body.settings);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(t,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a,u,i,o=e.Schema,c=e.router,l=e.authMiddleware,d=e.permissionMiddleware,f=e.asyncMiddleware,p=e.getConfig,h=e.handleResponse,v=e.handleError;c.post("/schema.:ext?",l,d.bind(null,"schema"),f((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=n,e.next=11,s.create(t.body.schema);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)}))),c.get("/schema.:ext?",l,d.bind(null,"schema"),f((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=n,e.next=11,s.read(t.query.schemaId);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)}))),c.put("/schema.:ext?",l,d.bind(null,"schema"),f((a=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=n,e.next=11,s.update(t.body.schema);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return a.apply(this,arguments)}))),c.delete("/schema.:ext?",l,d.bind(null,"schema"),f((u=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=n,e.next=11,s.delete(t.body.schemaSlug||t.body.schemaSlugs||t.query.schemaSlug||t.query.schemaSlugs);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return u.apply(this,arguments)}))),c.put("/schemas.:ext?",l,d.bind(null,"schema"),f((i=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=o,e.next=3,p(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=h,e.t3=t,e.t4=n,e.next=11,s.updateAll(t.body.schemas);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),v(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return i.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(2);e.exports=function(e){var t,n,u,o,c=e.Pdf,l=e.ClientConfig,d=e.router,f=e.asyncMiddleware,p=e.getConfig,h=e.handleError;d.get("/pdf/view.:ext?",f((t=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=c,e.next=3,p(t.session.slug);case 3:e.t1=e.sent,(r=(0,e.t0)(e.t1)).getPayload(t.query.template,t.query.id,t.session.role).then(function(e){r.getPdf(e).then(function(e){n.type("application/pdf"),n.status(200),n.send(e)},h.bind(null,t,n))},h.bind(null,t,n));case 6:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)}))),d.get("/pdf/download.:ext?",f((n=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=c,e.next=3,p(t.session.slug);case 3:e.t1=e.sent,(r=(0,e.t0)(e.t1)).getPayload(t.query.template,t.query.id,t.session.role).then(function(e){r.getPdf(e).then(function(t){n.attachment(e.fileName||"download.pdf"),n.status(200),n.send(t)},h.bind(null,t,n))},h.bind(null,t,n));case 6:case"end":return e.stop()}},e,void 0)})),function(e,t){return n.apply(this,arguments)}))),d.get("/pdf/payload.:ext?",f((u=(0,a.default)(s.default.mark(function e(t,n){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=c,e.next=3,p(t.session.slug);case 3:e.t1=e.sent,(0,e.t0)(e.t1).getPayload(t.query.template,t.query.id,t.session.role).then(function(e){n.status(200),n.json(e)},h.bind(null,t,n));case 6:case"end":return e.stop()}},e,void 0)})),function(e,t){return u.apply(this,arguments)}))),d.get("/pdf/submit.:ext?",f((o=(0,a.default)(s.default.mark(function e(t,n){var a,u,o,d;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p(t.session.slug);case 2:return a=e.sent,u=l(a),e.next=6,u.get();case 6:o=e.sent,d=i.get(o,"assets.slug",t.session.slug),c(a).getPayload(t.query.template,t.query.id,t.session.role).then(function(e){e=(0,r.default)(e).replace(/'/gi,"’"),n.status(200),n.send("\n          <body onload='form.submit()'>\n            <form id='form' method='POST' action='"+a.assist.url+"/"+d+"/pdf/download' target='_self'>\n              <input type='hidden' name='payload' value='"+e+"' />\n            </form>\n          </body>\n        ")},h.bind(null,t,n));case 10:case"end":return e.stop()}},e,void 0)})),function(e,t){return o.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.ClientConfig,a=e.router,u=e.cacheMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;a.get("/metadata.:ext?",u,i((t=(0,s.default)(r.default.mark(function e(t,s){var a,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,o(t.session.slug);case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.next=7,a.get();case 7:u=e.sent;try{c(t,s,u.client.metadata,!0)}catch(e){l(t,s,e)}case 9:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=i(n(13)),s=i(n(10)),a=i(n(1)),u=i(n(0));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(11);e.exports=function(e){var t,n,i,c,l,d,f,p,h,v,m,y=e.Db,g=e.Entity,x=e.router,b=e.authMiddleware,w=e.permissionMiddleware,k=e.cacheMiddleware,_=e.asyncMiddleware,E=e.getConfig,S=e.handleResponse,T=e.handleError;x.get("/entities/index.:ext?",_((t=(0,u.default)(a.default.mark(function e(t,n){return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.t0=S,e.t1=t,e.t2=n,e.t3=y,e.next=7,E(t.session.slug);case 7:return e.t4=e.sent,e.next=10,(0,e.t3)(e.t4).indexAsync();case 10:e.t5=e.sent,(0,e.t0)(e.t1,e.t2,e.t5),e.next=17;break;case 14:e.prev=14,e.t6=e.catch(0),T(t,n,e.t6);case 17:case"end":return e.stop()}},e,void 0,[[0,14]])})),function(e,n){return t.apply(this,arguments)}))),x.all("/entities/search?.:ext?",k,_((n=(0,u.default)(a.default.mark(function e(t,n){var u,i,o,c,l,d,f,p,h,v,m,y,x,b;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return u=(0,s.default)(t.body).length?t.body:t.query,i=void 0!==u.include_docs&&JSON.parse(u.include_docs),o=void 0!==u.include_fields?"object"===(0,r.default)(u.include_fields)?u.include_fields:JSON.parse(u.include_fields):[],c=void 0!==u.children&&("object"===(0,r.default)(u.children)?u.children:JSON.parse(u.children)),l=void 0!==u.parents&&("object"===(0,r.default)(u.parents)?u.parents:JSON.parse(u.parents)),d=void 0!==u.trashed&&JSON.parse(u.trashed),f=void 0!==u.sort?u.sort:null,p=void 0!==u.limit?parseInt(u.limit,10):null,h=void 0!==u.bookmark?u.bookmark:null,v=void 0!==u.group_field?u.group_field:null,m=void 0!==u.index?u.index:null,y=u.query||u.q,!0===c&&(c=1),!0===l&&(l=1),(x=[]).push(d?"trashed:true":"!trashed:true"),"guest"===t.session.role&&x.push("published:true"),y&&x.push("("+y+")"),x=x.join(" AND "),e.t0=g,e.next=22,E(t.session.slug);case 22:return e.t1=e.sent,b=(0,e.t0)(e.t1),e.prev=24,e.t2=S,e.t3=t,e.t4=n,e.next=30,b.entitySearch({query:x,include_docs:i,include_fields:o,sort:f,limit:p,bookmark:h,group_field:v,index:m},c,l,t.session.role);case 30:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=37;break;case 34:e.prev=34,e.t6=e.catch(24),T(t,n,e.t6);case 37:case"end":return e.stop()}},e,void 0,[[24,34]])})),function(e,t){return n.apply(this,arguments)}))),x.all("/entities/find.:ext?",k,_((i=(0,u.default)(a.default.mark(function e(t,n){var r,s,u,i,o;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0!==(t.query.children||t.body.children)&&JSON.parse(t.query.children||t.body.children),s=void 0!==(t.query.parents||t.body.parents)&&JSON.parse(t.query.parents||t.body.parents),u=void 0!==(t.query.trashed||t.body.trashed)&&JSON.parse(t.query.trashed||t.body.trashed),(i=t.query.query||t.body.query?JSON.parse(t.query.query||t.body.query):{selector:{}}).use_index=["entityIndex","entity"],!0===r&&(r=1),!0===s&&(s=1),i.selector.$and||(i.selector={$and:[i.selector]}),u?i.selector.$and.push({trashed:!0}):i.selector.$and.push({$or:[{trashed:{$exists:!1}},{trashed:!1}]}),"guest"===t.session.role&&i.selector.$and.push({published:!0}),t.query.limit&&(i.limit=parseInt(t.query.limit,10)),e.t0=g,e.next=14,E(t.session.slug);case 14:return e.t1=e.sent,o=(0,e.t0)(e.t1),e.prev=16,e.t2=S,e.t3=t,e.t4=n,e.next=22,o.entityFind(i,r,s,t.session.role);case 22:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=29;break;case 26:e.prev=26,e.t6=e.catch(16),T(t,n,e.t6);case 29:case"end":return e.stop()}},e,void 0,[[16,26]])})),function(e,t){return i.apply(this,arguments)}))),x.get("/entities/field.:ext?",k,_((c=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.fieldValues(t.query.slug||t.query.fieldSlug,t.query.searchTerm);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return c.apply(this,arguments)}))),x.all("/entities.:ext?",k,_((l=(0,u.default)(a.default.mark(function e(t,n){var r,s,u,i;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0!==(t.query.children||t.body.children)&&JSON.parse(t.query.children||t.body.children),s=void 0!==(t.query.parents||t.body.parents)&&JSON.parse(t.query.parents||t.body.parents),!0===r&&(r=1),!0===s&&(s=1),(u=t.query.ids||t.query.id||t.body.ids||t.body.id)&&(u=o(u)?u:[u]),e.t0=g,e.next=9,E(t.session.slug);case 9:return e.t1=e.sent,i=(0,e.t0)(e.t1),e.prev=11,e.t2=S,e.t3=t,e.t4=n,e.next=17,i.entityList(u,r,s,t.session.role);case 17:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=24;break;case 21:e.prev=21,e.t6=e.catch(11),T(t,n,e.t6);case 24:case"end":return e.stop()}},e,void 0,[[11,21]])})),function(e,t){return l.apply(this,arguments)}))),x.get("/entity/revisions.:ext?",b,w.bind(null,"entityRead"),_((d=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityRevisions(t.query.id);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return d.apply(this,arguments)}))),x.post("/entity.:ext?",b,w.bind(null,"entityCreate"),_((f=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityCreate(t.body.entity);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return f.apply(this,arguments)}))),x.get("/entity.:ext?",b,w.bind(null,"entityRead"),_((p=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityRead(t.query.id);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return p.apply(this,arguments)}))),x.put("/entity.:ext?",b,w.bind(null,"entityUpdate"),_((h=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityUpdate(t.body.entity||t.body.entities,t.body.restore||!1);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return h.apply(this,arguments)}))),x.delete("/entity.:ext?",b,w.bind(null,"entityDelete"),_((v=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityDelete(t.body.entity||t.body.entities,t.body.forever||!1);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return v.apply(this,arguments)}))),x.delete("/entity/trashed.:ext?",b,w.bind(null,"entityDelete"),_((m=(0,u.default)(a.default.mark(function e(t,n){var r;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=g,e.next=3,E(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=S,e.t3=t,e.t4=n,e.next=11,r.entityDelete("trashed");case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),T(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return m.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.Embedly,a=e.router,u=e.authMiddleware,i=e.asyncMiddleware,o=e.getConfig,c=e.handleResponse,l=e.handleError;a.get("/embedly/oembed.:ext?",u,i((t=(0,s.default)(r.default.mark(function e(t,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,o();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=c,e.t3=t,e.t4=s,e.next=11,a.oembed(t.query.url||t.query.urls);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),l(t,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=u(n(1)),s=u(n(10)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,u=e.Email,i=e.Entity,o=e.router,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError;o.all("/email/template.:ext?",c((t=(0,a.default)(r.default.mark(function e(t,n){var o,c,p,h,v,m,y=(o=(0,a.default)(r.default.mark(function e(){var s,a,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!p.data){e.next=3;break}return d(t,n,i),e.abrupt("return");case 3:return e.t0=u,e.next=6,l(h);case 6:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.next=10,s.getTemplate(h+"/"+c.templateSlug,i,p);case 10:a=e.sent;try{d(t,n,a.html)}catch(e){f(t,n,e)}case 12:case"end":return e.stop()}},e,this)})),function(){return o.apply(this,arguments)});return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=(0,s.default)(t.body).length?t.body:t.query||{},p={data:!!c.data&&JSON.parse(c.data),preview:!!c.preview&&JSON.parse(c.preview),inky:!!c.inky&&JSON.parse(c.inky),mjml:!!c.mjml&&JSON.parse(c.mjml),skipValidation:!!c.skipValidation&&JSON.parse(c.skipValidation)},h=t.session.slug||c.slug){e.next=5;break}throw new Error("missing slug param");case 5:if(!c.payload){e.next=8;break}return y(JSON.parse(c.payload)),e.abrupt("return");case 8:if(!c.entityId){e.next=20;break}return e.t0=i,e.next=12,l(h);case 12:return e.t1=e.sent,v=(0,e.t0)(e.t1),e.next=16,v.entityList([c.entityId],2);case 16:return e.t2=function(e){return e.doc},m=e.sent.map(e.t2),y(v.flattenValues(m)[0]),e.abrupt("return");case 20:y();case 21:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)}))),o.post("/email/subscribe.:ext?",c((n=(0,a.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=u,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=t,e.t4=n,e.next=11,s.subscribe({email:t.body.email||t.query.email,name:t.body.name||t.query.name||""});case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=u(n(8)),s=u(n(1)),a=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var i=n(11);e.exports=function(e){var t,n,u,o,c,l=e.Ecommerce,d=e.router,f=e.authMiddleware,p=e.permissionMiddleware,h=e.asyncMiddleware,v=e.getConfig,m=e.handleResponse,y=e.handleError;d.get("/ecommerce/order/message/:message.:ext?",f,p.bind(null,"ecommerce"),h((t=(0,a.default)(s.default.mark(function e(t,n){var r,a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,v(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.next=8,r.getOrder(t.query.orderId);case 8:a=e.sent,m(t,n,a.messages[t.params.message].email.html),e.next=15;break;case 12:e.prev=12,e.t2=e.catch(5),y(t,n,e.t2);case 15:case"end":return e.stop()}},e,void 0,[[5,12]])})),function(e,n){return t.apply(this,arguments)}))),d.get("/ecommerce/:type.:ext?",f,p.bind(null,"ecommerce"),h((n=(0,a.default)(s.default.mark(function e(t,n){var a;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i(t.query.sort)&&(t.query.sort=(0,r.default)(t.query.sort).replace(/\\"/g,"")),e.t0=l,e.next=4,v(t.session.slug);case 4:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=6,e.t2=m,e.t3=t,e.t4=n,e.next=12,a.getType(t.params.type,t.query);case 12:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=19;break;case 16:e.prev=16,e.t6=e.catch(6),y(t,n,e.t6);case 19:case"end":return e.stop()}},e,void 0,[[6,16]])})),function(e,t){return n.apply(this,arguments)}))),d.post("/ecommerce/:type.:ext?",f,p.bind(null,"ecommerce"),h((u=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(/^(discount|order)$/.test(t.params.type)){e.next=3;break}return y(t,n,"Illegal type: "+t.params.type),e.abrupt("return");case 3:return e.t0=l,e.next=6,v(t.session.slug);case 6:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=8,e.t2=m,e.t3=t,e.t4=n,e.next=14,r.setType(t.params.type,t.body.item);case 14:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=21;break;case 18:e.prev=18,e.t6=e.catch(8),y(t,n,e.t6);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])})),function(e,t){return u.apply(this,arguments)}))),d.delete("/ecommerce/:type.:ext?",f,p.bind(null,"ecommerce"),h((o=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(/^(discount)$/.test(t.params.type)){e.next=3;break}return y(t,n,"Illegal type: "+t.params.type),e.abrupt("return");case 3:return e.t0=l,e.next=6,v(t.session.slug);case 6:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=8,e.t2=m,e.t3=t,e.t4=n,e.next=14,r.deleteType(t.body.item);case 14:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=21;break;case 18:e.prev=18,e.t6=e.catch(8),y(t,n,e.t6);case 21:case"end":return e.stop()}},e,void 0,[[8,18]])})),function(e,t){return o.apply(this,arguments)}))),d.get("/ecommerce/discount/:code.:ext?",h((c=(0,a.default)(s.default.mark(function e(t,n){var r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=l,e.next=3,v(t.session.slug);case 3:return e.t1=e.sent,r=(0,e.t0)(e.t1),e.prev=5,e.t2=m,e.t3=t,e.t4=n,e.next=11,r.verifyDiscount(t.params.code);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),y(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return c.apply(this,arguments)})))}},function(e,t){e.exports=require("express-useragent")},function(e,t,n){"use strict";e.exports=function(e){e.router.all("/debug/useragent.:ext?",function(e,t){var r=n(43).parse(e.headers["user-agent"]);t.status(200),t.send("\n      <html>\n        <head>\n          <title>"+r.source+'</title>\n          <meta name="description" content="'+r.source+'">\n        </head>\n        <body>'+r.source+"</body>\n      </html>\n    ")})}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a=e.ClientConfig,u=e.router,i=e.authMiddleware,o=e.permissionMiddleware,c=e.asyncMiddleware,l=e.getConfig,d=e.handleResponse,f=e.handleError;u.get("/config.:ext?",i,c((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=a,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=t,e.t4=n,e.next=11,s.get();case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)}))),u.post("/config.:ext?",i,o.bind(null,"config"),c((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=a,e.next=3,l(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=d,e.t3=t,e.t4=n,e.next=11,s.set(t.body.config);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),f(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.router,a=e.cache,u=e.asyncMiddleware,i=e.getConfig,o=e.handleResponse;n.get("/cache/clear.:ext?",u((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i();case 2:if(e.sent.cache.enabled){e.next=6;break}return o(t,n,"Cache disabled"),e.abrupt("return");case 6:s=[],a.forEach(function(e,n){0===n.indexOf(t.session.slug)&&s.push(n)}),s.forEach(function(e){return a.del(e)}),o(t,n,s.length+" items removed from cache");case 10:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n,a,u=e.Auth,i=e.router,o=e.authMiddleware,c=e.permissionMiddleware,l=e.asyncMiddleware,d=e.getConfig,f=e.handleResponse,p=e.handleError;i.get("/auth/:provider/config.:ext?",o,c.bind(null,"settings"),l((t=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d();case 2:if((s=e.sent)[t.params.provider]){e.next=7;break}return n.status(404),n.send({}),e.abrupt("return");case 7:n.status(200),n.send({clientId:s[t.params.provider].clientId});case 9:case"end":return e.stop()}},e,void 0)})),function(e,n){return t.apply(this,arguments)}))),i.get("/auth/:provider.:ext?",o,c.bind(null,"settings"),function(e,t){t.status(e.query.error?500:200),t.send(e.params.provider+": "+(e.query.error_description?e.query.error_description:"successfully authenticated"))}),i.post("/auth/:provider.:ext?",o,c.bind(null,"settings"),l((n=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=u,e.next=3,d(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=f,e.t3=t,e.t4=n,e.next=11,s.authenticateWithProvider(t.params.provider,t.body);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),p(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return n.apply(this,arguments)}))),i.put("/auth/:provider.:ext?",o,c.bind(null,"settings"),l((a=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=u,e.next=3,d(t.session.slug);case 3:return e.t1=e.sent,s=(0,e.t0)(e.t1),e.prev=5,e.t2=f,e.t3=t,e.t4=n,e.next=11,s.authenticateWithProvider(t.params.provider,t.body,!0);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),p(t,n,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,t){return a.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=a(n(1)),s=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=function(e){var t,n=e.Analytics,a=e.router,u=e.authMiddleware,i=e.cacheMiddleware,o=e.asyncMiddleware,c=e.getConfig,l=e.handleResponse,d=e.handleError;a.get("/analytics.:ext?",u,i,o((t=(0,s.default)(r.default.mark(function e(t,s){var a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=n,e.next=3,c();case 3:return e.t1=e.sent,a=(0,e.t0)(e.t1),e.prev=5,e.t2=l,e.t3=t,e.t4=s,e.next=11,a.get(t.query);case 11:e.t5=e.sent,(0,e.t2)(e.t3,e.t4,e.t5,!0),e.next=18;break;case 15:e.prev=15,e.t6=e.catch(5),d(t,s,e.t6);case 18:case"end":return e.stop()}},e,void 0,[[5,15]])})),function(e,n){return t.apply(this,arguments)})))}},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).users.push(t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.users,{id:t})){e.next=7;break}throw Error("User not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.users,{id:t.id}))){e.next=7;break}throw Error("User not found: "+t.id);case 7:return s.users.splice(a,1,t),e.abrupt("return",n.set(s));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.users=s.users.filter(function(e){return-1===t.indexOf(e.id)}),e.abrupt("return",n.set(s));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(6).promisifyAll(n(18)),c=n(22),l=n(7),d=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"getDb",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).fetch({include_docs:!0});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getChanges",value:function(){var e=(0,s.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"importDb",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a,u,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.config.db.name,e.next=3,o.readFileAsync(t.path);case 3:return s=e.sent,a=JSON.parse(s).rows.map(function(e){var t=e.doc;return delete t._rev,t}),e.next=7,o.unlinkAsync(t.path);case 7:return u=new c({url:this.config.db.url,plugins:["promises","retry"]}).db,e.prev=8,e.next=11,u.destroy(n);case 11:e.next=15;break;case 13:e.prev=13,e.t0=e.catch(8);case 15:return e.next=17,u.create(n);case 17:return e.next=19,l.connect(this.config,n).bulk({docs:a});case 19:return i=e.sent,e.abrupt("return",i);case 21:case"end":return e.stop()}},e,this,[[8,13]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(7),l=n(5),d=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"create",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return(s=e.sent).taxonomies.push(t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(s=e.sent,a=o.find(s.taxonomies,{slug:t})){e.next=7;break}throw Error("Taxonomy not found: "+t);case 7:return e.abrupt("return",a);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(s=e.sent,-1!==(a=o.findIndex(s.taxonomies,{slug:t.slug}))){e.next=7;break}throw Error("Taxonomy not found: "+t.slug);case 7:return s.taxonomies.splice(a,1,t),e.abrupt("return",n.set(s));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return s=e.sent,t=o.isArray(t)?t:[t],s.taxonomies=s.taxonomies.filter(function(e){return-1===t.indexOf(e.slug)}),e.abrupt("return",n.set(s));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"entitiesByTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.connect(this.config),e.next=3,n.view("entity","byTaxonomyTerm",{keys:[t.id],group:!0});case 3:if(e.t0=function(e){return e.value},s=e.sent.rows.map(e.t0)[0]){e.next=7;break}return e.abrupt("return",[]);case 7:return a=[],o.forEach(s,function(e){a=a.concat(e)}),a=o.uniq(a),e.next=12,n.fetch({keys:a,include_docs:!0});case 12:return e.t1=function(e){return e.doc},e.abrupt("return",e.sent.rows.map(e.t1));case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.read(t);case 2:return(s=e.sent).terms.push(n),e.abrupt("return",this.update(s));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e.parents||(e.parents=[]),e.parents=e.parents.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e}),e})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteTerm",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.filter(function(e){return e.id!==t.id&&!(e.parents||[]).filter(function(e){return e.id===t.id}).length})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t){e.exports=require("hashids")},function(e,t){e.exports=require("stripe")},function(e,t,n){"use strict";var r=o(n(8)),s=o(n(1)),a=o(n(0)),u=o(n(4)),i=o(n(3));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(53),d=n(6),f=n(52),p=n(5),h=n(19),v=n(7),m=n(9),y=function(){function e(t){(0,u.default)(this,e),this.config=t,this.stripe=l(this.config.stripe.apiKey),this.email=new h(this.config),this.hashids=new f(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}return(0,i.default)(e,[{key:"getSettings",value:function(){var e=(0,a.default)(s.default.mark(function e(){var t,n,r;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new p(this.config),e.next=3,t.get();case 3:n=e.sent,r=void 0,e.prev=5,r=n.module.ecommerce,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(5),new Error(e.t0);case 12:e.prev=12,r.clientStripeAccountId=n.provider.stripe.stripe_user_id,e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(12),new Error(e.t1);case 19:return r.client=n.client,r.assets=n.assets,e.abrupt("return",r);case 22:case"end":return e.stop()}},e,this,[[5,9],[12,16]])}));return function(){return e.apply(this,arguments)}}()},{key:"checkout",value:function(e,t){var n=this;return new d(function(r,s){n.getSettings().then(function(a){var u=c.get(a,"createsend.checkoutSubscriberListId");t.subscribe&&u&&n.email.subscribe(t.customerDetails,"createsend",u).then(function(e){console.log(e)},function(e){console.error(e)}),n.findOrCreateCustomer(t.customerDetails.email,t).then(function(u){n.createOrder(t,u).then(function(t){n.updateOrCreateStripeCustomer(a.clientStripeAccountId,u,e,t).then(function(e){n.updateCustomer(u,e,t).then(function(u){n.createCharge(a,e,u,t).then(function(e){n.sendReceipt(a,u,t).then(function(i){e.messages.orderReceipt=i,n.sendNotification(a,u,t).then(function(t){e.messages.orderNotification=t,n.updateOrder(e).then(function(e){r(e)},s)},s)},s)},s)},s)},s)},s)},s)},s).catch(s)})}},{key:"retrieveAccount",value:function(){var e=this;return new d(function(t,n){e.getSettings().then(function(r){e.stripe.accounts.retrieve(r.clientStripeAccountId).then(t,n)},n)})}},{key:"refund",value:function(e,t){var n=this;return new d(function(r,s){n.getSettings().then(function(a){n.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:a.clientStripeAccountId}).then(function(t){n.stripe.charges.retrieve(e.charge.id,{stripe_account:a.clientStripeAccountId}).then(function(t){e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,m.createOrUpdate(n.config,e).then(r,s)},s)},s)},s)})}},{key:"findOrCreateCustomer",value:function(e,t){var n=this;return new d(function(s,a){v.connect(n.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(function(e){if(e.rows.length)s(e.rows[0].doc);else{var u=(0,r.default)(new Date).replace(/"/g,""),i={type:"customer",createdAt:u,modifiedAt:u,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};v.connect(n.config).insert(i).then(function(e){i._id=e.id,i._rev=e.rev,s(i)},a)}},a)})}},{key:"updateOrCreateStripeCustomer",value:function(e,t,n,r){var s=this;return new d(function(a,u){var i={source:n,email:r.customer.email,description:r.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?s.stripe.customers.update(t.stripe.customer.id,i,{stripe_account:e}).then(a,function(t){"StripeInvalidRequestError"===t.type&&"id"===t.param?s.stripe.customers.create(i,{stripe_account:e}).then(a,u):u(t)}):s.stripe.customers.create(i,{stripe_account:e}).then(a,u)})}},{key:"createOrder",value:function(e,t){var n=this;return new d(function(s,a){var u=e.items.map(function(e){return{id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}}}),i=(0,r.default)(new Date).replace(/"/g,""),o={type:"order",orderId:n.hashids.encode((new Date).getTime()),createdAt:i,modifiedAt:i,customer:{id:t._id,email:t.email,name:t.name},items:u,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};v.connect(n.config).insert(o).then(function(e){o._id=e.id,o._rev=e.rev,s(o)},a)})}},{key:"updateOrder",value:function(e){var t=this;return new d(function(n,r){v.connect(t.config).insert(e).then(function(t){e._rev=t.rev,n(e)},r)})}},{key:"updateCustomer",value:function(e,t,n){var s=this;return new d(function(a,u){var i=(0,r.default)(new Date).replace(/"/g,"");e.modifiedAt=i,e.orders||(e.orders=[]),e.orders.push(n._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,v.connect(s.config).insert(e).then(function(t){e._rev=t.rev,a(e)},u)})}},{key:"createCharge",value:function(e,t,n,r){var s=this;return new d(function(a,u){var i=100*Number(r.total),o={amount:i,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:r.orderId,metadata:{customer_id:n._id,order_id:r._id},statement_descriptor:c.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*i)};s.stripe.charges.create(o,{stripe_account:e.clientStripeAccountId}).then(function(e){r.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},r.test=!e.livemode,a(r)},u)})}},{key:"sendReceipt",value:function(e,t,n){var r=this;return new d(function(s,a){var u={settings:e,order:n},i={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:t.email,subject:"Your order at "+e.storeName+" ("+n.orderId+")"},o=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(i,o+"/order-receipt",u).then(s,a)})}},{key:"sendNotification",value:function(e,t,n){var r=this;return new d(function(t,s){var a={settings:e,order:n},u={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:e.emailSenderAddress,subject:"New order at "+e.storeName+" ("+n.orderId+")"},i=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(u,i+"/order-notification",a).then(t,s)})}}]),e}();e.exports=y},function(e,t){e.exports=require("shippo")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(6),i=n(55),o=function(){function e(t){(0,r.default)(this,e),this.config=t,this.shippo=i(t.shippo.token)}return(0,s.default)(e,[{key:"getQuote",value:function(e,t){var n=this;return new u(function(r,s){var a={object_purpose:"QUOTE",zip:n.config.shippo.fromZip,country:n.config.shippo.fromCountry},u={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",n.shippo.shipment.create({object_purpose:"QUOTE",address_from:a,address_to:u,parcel:t}).then(function(e){!function e(t,a){("QUEUED"===t.object_status||"WAITING"===t.object_status)&&a<10?n.shippo.shipment.retrieve(t.object_id).then(function(t){e(t,a+1)}):n.shippo.shipment.rates(t.object_id).then(function(e){r(e)},function(e){console.error("There was an error retrieving rates : %s",e),s(e)})}(e,0)},function(e){console.error("There was an error creating shipment: %s",e),s(e)})})}}]),e}();e.exports=o},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(5),l=function(){function e(t){return(0,a.default)(this,e),this.config=t,this}return(0,u.default)(e,[{key:"update",value:function(){var e=(0,s.default)(r.default.mark(function e(t){var n,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(s=e.sent).client=o.merge({},s.client,t),e.abrupt("return",n.set(s));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=c(n(8)),s=c(n(13)),a=c(n(1)),u=c(n(0)),i=c(n(4)),o=c(n(3));function c(e){return e&&e.__esModule?e:{default:e}}var l=n(2),d=n(14),f=n(17),p=n(5),h=function(){function e(t){(0,i.default)(this,e),this.config=t,this.templates=this.config.pdf.templates}return(0,o.default)(e,[{key:"getPayload",value:function(){var e=(0,u.default)(a.default.mark(function e(t,n,r){var s,u,i;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.templates[t]){e.next=2;break}throw new Error("Template not found");case 2:return s=new f(this.config),e.next=5,s.entityList([n],2,!1,r);case 5:if(e.t0=function(e){return e.doc},0!==(u=e.sent.map(e.t0)).length){e.next=9;break}throw new Error("Entity not found");case 9:return i=this.templates[t](f.flattenValues(u)[0]),e.abrupt("return",i);case 11:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"getPdf",value:function(){var e=(0,u.default)(a.default.mark(function e(t){var n,u,i,o,c;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new p(this.config),e.next=3,n.get();case 3:return u=e.sent,i=l.get(u,"assets.slug",this.config.slug),o=this.config.assist.url+"/"+i+"/pdf/download",t="object"===(void 0===t?"undefined":(0,s.default)(t))?(0,r.default)(t).replace(/'/gi,"’"):t,e.next=9,d({method:"POST",uri:o,encoding:null,form:{payload:t}});case 9:return c=e.sent,e.abrupt("return",c);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=h},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(59),i=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"signToken",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.sign(e,this.config.auth.tokenSecret,t)}},{key:"verifyToken",value:function(e){return u.verify(e,this.config.auth.tokenSecret)}}]),e}();e.exports=i},function(e,t,n){"use strict";var r=n(2),s=n(6),a=n(14);e.exports=function(e){e=r.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{});this.get=function(t,n){return function(t,n,u){return new s(function(s,i){var o={method:t,url:[e.host,e.version,n].join("/"),qs:{access_token:u.access_token||e.access_token,client_id:u.client_id||e.client_id}};o.qs=r.extend({},o.qs,u),a(o).then(function(e){s(JSON.parse(e))},i)})}("GET",t,n)}}},function(e,t){e.exports=require("deep-diff")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("embedly")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),i=n(6),o=n(64),c=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"oembed",value:function(e){var t=this;return new i(function(n,r){var s=new o({key:t.config.embedly.apiKey}),a={urls:u.isArray(e)?e:[e],format:"json"};s.oembed(a,function(e,t){e?r(e):n(t)})})}}]),e}();e.exports=c},function(e,t){e.exports=require("node-sass")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("mjml-mailchimp")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("email-templates")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer")},function(e,t,n){"use strict";var r=a(n(4)),s=a(n(3));function a(e){return e&&e.__esModule?e:{default:e}}var u=n(2),i=n(6),o=n(7),c=n(9),l=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,s.default)(e,[{key:"getType",value:function(e,t){var n=this;return new i(function(r,s){t.sort=u.isString(t.sort)?'"'+t.sort+'"':t.sort,o.connect(n.config).search("ecommerce",e,t).then(r,s)})}},{key:"setType",value:function(e,t){var n=this;return new i(function(r,s){t.type=e,c.createOrUpdate(n.config,t).then(r,s)})}},{key:"deleteType",value:function(e){var t=this;return new i(function(n,r){e=e.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),c.chunkUpdate(t.config,e,1e3).then(n,r)})}},{key:"getOrder",value:function(e){var t=this;return new i(function(n,r){o.connect(t.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(function(e){e.rows.length?n(e.rows[0].doc):r(new Error("Order not found"))},r)})}},{key:"verifyDiscount",value:function(e){var t=this;return new i(function(n,r){o.connect(t.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(function(t){if(t.rows.length){var s=t.rows[0].doc,a=(new Date).getTime(),u=new Date(Date.parse(s.dateStart)).getTime(),i=new Date(Date.parse(s.dateEnd)).getTime();if(u>a)return void r(new Error("Discount not valid (not begun)"));if(i<a)return void r(new Error("Discount not valid (expired)"));n(s)}else r(new Error({statusCode:404,message:"Discount code not found ("+e+")"}))},r)})}}]),e}();e.exports=l},function(e,t){e.exports=require("querystring")},function(e,t,n){"use strict";var r=i(n(1)),s=i(n(0)),a=i(n(4)),u=i(n(3));function i(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(80),l=n(23),d=n(5),f=n(7),p={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token"},h=function(){function e(t){(0,a.default)(this,e),this.config=t}return(0,u.default)(e,[{key:"authoriseUser",value:function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.config.auth.superUserId.split(",").map(function(e){return e.trim()}).indexOf(n)>-1)){e.next=3;break}return e.abrupt("return",{id:n,role:"super"});case 3:return e.next=5,f.connect(this.config,t).get("config");case 5:if(s=e.sent,a=o.find(s.users,{id:n})){e.next=9;break}throw Error("User not found: "+n);case 9:if(a.active){e.next=11;break}throw Error("User not active: "+n);case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"authenticateWithProvider",value:function(){var e=(0,s.default)(r.default.mark(function e(t,n){var s,a,u,i,f,h,v,m=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=o.merge({},this.config[t],n),a={grant_type:m?"refresh_token":"authorization_code",client_id:s.clientId,client_secret:s.clientSecret,redirect_uri:s.redirectUri,code:n.code,refresh_token:n.refresh_token},u=p[t],i=void 0,e.prev=4,e.next=7,l.post(u,c.stringify(a));case 7:i=e.sent,e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(4),new Error(e.t0.response.data.error_description);case 13:return f=new d(this.config),e.next=16,f.get();case 16:if((h=e.sent).provider||(h.provider={}),v=o.merge({},h.provider[t]||{},i.data),"google"!==t){e.next=30;break}return v.expires=v.expires_in+Math.floor(+new Date/1e3),e.prev=21,e.next=24,l.get("https://www.googleapis.com/plus/v1/people/me?access_token="+v.access_token);case 24:v.user=e.sent.data,e.next=30;break;case 27:e.prev=27,e.t1=e.catch(21),console.error(e.t1);case 30:return h.provider[t]=v,e.abrupt("return",f.set(h));case 32:case"end":return e.stop()}},e,this,[[4,10],[21,27]])}));return function(t,n){return e.apply(this,arguments)}}()}]),e}();e.exports=h},function(e,t){e.exports=require("password-hash")},function(e,t,n){"use strict";(function(t){var r=n(25),s={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},aws:{iamAccessKeyId:process.env.AWS_IAM_ACCESS_KEY_ID,iamAccessKeySecret:process.env.AWS_IAM_ACCESS_KEY_SECRET,s3:{bucket:process.env.AWS_S3_BUCKET}},shippo:{token:process.env.SHIPPO_TOKEN,fromZip:process.env.SHIPPO_FROM_ZIP,fromCountry:process.env.SHIPPO_FROM_COUNTRY},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET},zencoder:{apiKey:process.env.ZENCODER_API_KEY,s3:{bucket:process.env.ZENCODER_S3_BUCKET,credentials:process.env.ZENCODER_S3_CREDENTIALS}},pdf:{templates:{}},email:{templatesPath:r.resolve(t,"email")}};e.exports=s}).call(this,"/")},function(e,t,n){"use strict";function r(){}r.defaultConfig=n(83),r.Assist=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(24),[null].concat(t)))},r.Auth=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(81),[null].concat(t)))},r.ClientConfig=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(5),[null].concat(t)))},r.Db=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(7),[null].concat(t)))},r.Ecommerce=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(79),[null].concat(t)))},r.Email=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(19),[null].concat(t)))},r.Embedly=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(65),[null].concat(t)))},r.Entity=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(17),[null].concat(t)))},r.Fields=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(15),[null].concat(t)))},r.Helpers=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(9),[null].concat(t)))},r.Instagram=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(61),[null].concat(t)))},r.Jwt=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(60),[null].concat(t)))},r.Pdf=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(58),[null].concat(t)))},r.Roles=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(21),[null].concat(t)))},r.Schema=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(16),[null].concat(t)))},r.Settings=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(57),[null].concat(t)))},r.Shippo=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(56),[null].concat(t)))},r.Stripe=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(54),[null].concat(t)))},r.Taxonomy=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(51),[null].concat(t)))},r.Tools=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(50),[null].concat(t)))},r.User=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(49),[null].concat(t)))},e.exports=r},function(e,t){e.exports=require("xxhashjs")},function(e,t){e.exports=require("deep-freeze")},function(e,t){e.exports=require("object-sizeof")},function(e,t){e.exports=require("circular-json-es6")},function(e,t){e.exports=require("le_node")},function(e,t){e.exports=require("zlib")},function(e,t){e.exports=require("url-parse")},function(e,t){e.exports=require("cache-manager-redis-store")},function(e,t){e.exports=require("cache-manager")},function(e,t,n){"use strict";var r=i(n(10)),s=i(n(1)),a=i(n(0)),u=i(n(8));function i(e){return e&&e.__esModule?e:{default:e}}process.on("unhandledRejection",function(e){return console.error(e)});var o=n(2),c=n(26),l=n(93),d=n(92),f=n(6),p=n(91),h=f.promisifyAll(n(90)),v=n(89),m=n(88),y=n(87),g=n(86),x=n(85),b=n(84),w=43981,k=n(12);e.exports=function(e){var t,i=this,_=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},E=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,S=g(o.merge({},b.defaultConfig,k,_)),T=function(e){return function(t,n,r){f.resolve(e(t,n,r)).catch(r)}},A=function(e){return"development"===S.environment&&["/token","/email/template"].indexOf(e.path)>-1},q=E||function(e,t,n){if(!A(e))return e.session.userId?void n():(t.status(401),void t.send({code:401,message:"Not authorised"}));n()},I=function(e){return o.mergeWith({},JSON.parse((0,u.default)(e)),function e(t){return o.forIn(t,function(t,n,r){o.isPlainObject(t)&&(t=e(t),0===o.keys(t).length&&delete r[n]),o.isUndefined(t)&&delete r[n]}),t}(o.cloneDeep(e)))},C=(t=(0,a.default)(s.default.mark(function e(t){var n;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(n=I(S)).slug=t,n.db.name=t,e.abrupt("return",n);case 4:case"end":return e.stop()}},e,i)})),function(e){return t.apply(this,arguments)}),M=void 0;if(S.cache.enabled)if(S.redis.url||S.redis.host){var O={ttl:S.cache.ttl};S.redis.url?O.url=S.redis.url:(O.host=S.redis.host,O.port=S.redis.port,O.password=S.redis.password,O.db=S.redis.db),(M=l.caching(o.merge({store:d},O))).store.getClient().on("error",function(e){console.error("redis: error:",e)})}else M=l.caching({store:"memory",ttl:S.cache.ttl,max:S.cache.memory.max,length:function(e){var t=y(e);return t}});var R,N,D=function(e){var t={slug:e.session.slug,path:e.path,query:e.query,body:e.body};return x.h64((0,u.default)(t),w).toString(16)},U=T((R=(0,a.default)(s.default.mark(function e(t,n,r){var a,u;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!S.cache.enabled||"guest"!==t.session.role||!1===(t.query.__cache&&JSON.parse(t.query.__cache))){e.next=22;break}return e.prev=2,a=D(t),e.next=6,M.get(a);case 6:if("string"!=typeof(u=e.sent)){e.next=17;break}if(!S.cache.compress){e.next=12;break}return e.next=11,h.gunzipAsync(Buffer.from(u,"base64"));case 11:u=e.sent.toString();case 12:try{u=JSON.parse(u)}catch(e){}return n.set("X-Cached-Response",!0),n.status(u?200:204),n.send(u),e.abrupt("return");case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),console.error(e.t0);case 22:n.set("X-Cached-Response",!1),r();case 24:case"end":return e.stop()}},e,i,[[2,19]])})),function(e,t,n){return R.apply(this,arguments)})),j=(N=(0,a.default)(s.default.mark(function e(t,n,r){var a,u=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===r||null===r?(r="",n.status(204),n.send(r)):(r=m.stringify(r),n.status(200),n.send(JSON.parse(r))),!u||!S.cache.enabled||"guest"!==t.session.role){e.next=8;break}if(a=D(t),!S.cache.compress){e.next=7;break}return e.next=6,h.gzipAsync(Buffer.from(r));case 6:r=e.sent.toString("base64");case 7:M.set(a,r);case 8:case"end":return e.stop()}},e,i)})),function(e,t,n){return N.apply(this,arguments)}),P=b.Jwt(S),L=c.Router();"production"===S.environment&&!0===S.forceHttps&&(e.enable&&e.enable("trust proxy"),e.use(function(e,t,n){e.headers["x-forwarded-proto"]&&"https"!==e.headers["x-forwarded-proto"]&&e.headers["cf-visitor"]&&"https"!==JSON.parse(e.headers["cf-visitor"]).scheme?t.redirect(301,"https://"+e.headers.host+e.path):n()})),e.use("/"+S.api.prefix,function(e,t,n){var r={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,PUT,POST,DELETE,OPTIONS","Access-Control-Expose-Headers":"X-Slug, X-Role, X-User-Id",Vary:"Accept-Encoding, X-Api-Token"};e.headers["access-control-request-headers"]&&(r["Access-Control-Allow-Headers"]=e.headers["access-control-request-headers"]),t.set(r),"OPTIONS"!==e.method?n():t.sendStatus(200)},function(e,t,n){if(A(e))n();else{var r=e.headers.referrer||e.headers.referer;if(r){var s=new p(r).hostname.split(".").slice(-2).join(".");if(S.api.blacklistReferrer.indexOf(s)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, referrer blacklisted"})}var a=e.headers["x-api-token"]||e.query.apiToken||e.session.apiToken;if(!a)return t.status(401),void t.send({code:401,message:"Not authorised, missing token"});if(S.api.blacklistToken.indexOf(a)>-1)return t.status(401),void t.send({code:401,message:"Not authorised, token blacklisted"});try{var u=P.verifyToken(a);e.session.userId=u.userId,e.session.slug=u.slug,e.session.role=u.role||"guest"}catch(e){return t.status(401),void t.send({code:401,message:"Not authorised, token verification failed ("+e.message+")",error:e})}if(!e.session.slug)return t.status(401),void t.send({code:401,message:"Not authorised, missing slug"});e.session.role||(e.session.role="guest"),e.session.userId&&t.set("X-User-Id",e.session.userId),t.set("X-Environment",S.environment),t.set("X-Slug",e.session.slug),t.set("X-Role",e.session.role),n()}},L),e.get("/"+S.api.prefix,function(e,t){t.send("<pre> ______\n|A     |\n|  /\\  |\n| /  \\ |\n|(    )|\n|  )(  |\n|______|</pre>")});var F={app:e,router:L,cache:M,authMiddleware:q,permissionMiddleware:function(e,t,n,r){if(!t.session.role)return n.status(401),void n.send({permission:e,message:"Error: role not defined in session."});if("super"!==t.session.role){var s=b.Roles();if(!s.role(t.session.role)||!0!==s.role(t.session.role).permissions[e])return n.status(401),void n.send({permission:e,message:"Sorry, you're not authorised to do this."});r()}else r()},cacheMiddleware:U,asyncMiddleware:T,getConfig:C,handleResponse:j,handleError:function(e,t,n){o.isObject(n)&&(n=JSON.parse(m.stringify(n)));var r=n.statusCode||n.code||500,s=n.stack||n.error||n.message||n.body||n.data||n;console.error(s),t.status("string"==typeof r?500:r),t.send({code:r,message:s})}};(0,r.default)(b).forEach(function(e){F[e]=b[e]}),S.logentriesToken&&(F.log=new v({token:S.logentriesToken}));var B=function e(t,n){n.removeListener("finish",e),n.removeListener("close",e)};return"production"!==S.environment&&e.use(function(e,t,n){t.on("finish",B.bind(null,e,t)),t.on("close",B.bind(null,e,t)),n()}),n(48)(F,S),n(47)(F,S),n(46)(F,S),n(45)(F,S),n(44)(F,S),n(42)(F,S),n(41)(F,S),n(40)(F,S),n(39)(F,S),n(38)(F,S),n(37)(F,S),n(36)(F,S),n(35)(F,S),n(34)(F,S),n(33)(F,S),n(31)(F,S),n(30)(F,S),n(29)(F,S),n(28)(F,S),n(27)(F,S),e}},function(e,t){e.exports=require("connect-redis")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("method-override")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("http")},function(e,t,n){"use strict";var r=process.env.PORT||5e3,s=process.env.HOST||"localhost",a=n(2),u=n(26),i=n(102),o=n(101),c=n(100),l=n(99),d=n(98),f=n(97),p=n(96),h=n(95)(p),v=n(94),m=n(12);e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=a.merge({},m,e),y=u(),g={secret:n.session.secret,resave:!0,saveUninitialized:!0};if(n.redis.url||n.redis.host){var x={ttl:n.session.ttl};n.redis.url?x.url=n.redis.url:(x.host=n.redis.host,x.port=n.redis.port,x.password=n.redis.password,x.db=n.redis.db),g.store=new h(x)}else g.cookie={maxAge:n.session.ttl};if(y.use(c()),y.use(o("tiny")),y.use(l()),y.use(d.json({limit:"50mb"})),y.use(d.urlencoded({extended:!0,limit:"50mb"})),y.use(f()),y.use(p(g)),v(y,n),t){var b=i.createServer(y);b.on("listening",function(){console.log("listening: http://"+s+":"+r)}),b.listen(r)}return y}}])});
//# sourceMappingURL=server.js.map