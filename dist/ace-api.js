!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AceApi=t():e.AceApi=t()}(global,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=67)}([function(e,t){e.exports=require("babel-runtime/helpers/createClass")},function(e,t){e.exports=require("babel-runtime/helpers/classCallCheck")},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(6),l=n(8),d={_id:"config",client:{},schemas:[],taxonomies:[],users:[],roles:(new(n(22))).roles()},f=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,a.default)(e,[{key:"get",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=d,e.prev=1,e.next=4,c.connect(this.config).get("config");case 4:t=e.sent,t=o.merge({},d,t),e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:return t.slug=this.config.slug,e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this,[[1,8]])}));return function(){return e.apply(this,arguments)}}()},{key:"set",value:function(){var e=(0,i.default)(r.default.mark(function e(t){return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t._id="config",delete t.roles,e.next=4,l.createOrUpdate(this.config,t);case 4:return t=e.sent,t=o.merge({},d,t),e.abrupt("return",t);case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("babel-runtime/regenerator")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(23),s=function(){function e(t,n){return(0,r.default)(this,e),this.config=t,e.connect(t,n)}return(0,i.default)(e,null,[{key:"connect",value:function(e,t){return new a({url:e.db.url,maxAttempt:5,plugins:["promises",{retry:{retryDelayMultiplier:2,retryInitialDelayMsecs:500}}]}).db.use(t||e.db.name)}}]),e}();e.exports=s},function(e,t){e.exports=require("bluebird")},function(e,t,n){"use strict";var r=a(n(9)),i=a(n(1)),u=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var s=n(2),o=n(7),c=n(6),l=function(){function e(t){(0,i.default)(this,e),this.config=t,this.assistUrl=t.assist.url,this.slug=t.slug}return(0,u.default)(e,[{key:"thumbnailSrc",value:function(e,t,n,r){if(!e)return"";var i=void 0;"string"==typeof t&&(i=t.split(/,|;/),t={},i.forEach(function(e){e=e.split(/_|:/),t[e[0]]=e[1]}));var u=!!e.crops&&e.crops[n];u?(t.x=u[0],t.y=u[1],t.x2=u[2],t.y2=u[3]):r&&(t.g=r),i=[],s.forEach(t,function(e,t){i.push([t,e].join(":"))});var a=i.join(";");if(/(image)/.test(e.thumbnailType))return"svg"===e.ext?[this.assistUrl,this.slug,e.name+e.ext].join("/"):[this.assistUrl,this.slug,"transform",a,e.name+e.ext].join("/");if(/(video)/.test(e.thumbnailType))return[this.assistUrl,this.slug,"transform",a,e.name,"thumb.jpg"].join("/");if(/(oembed|proxy)/.test(e.thumbnailType)){var o=e.thumbnailUrl.replace(/https?:\/\//,"");return[this.assistUrl,this.slug,"proxy","transform",a,o].join("/")}return""}}],[{key:"createOrUpdate",value:function(e,t){return new o(function(n,r){c.connect(e).insert(t).then(function(e){t._id=e.id,t._rev=e.rev,n(t)},function(i){409===i.statusCode?c.connect(e).get(t._id).then(function(i){t._rev=i._rev,c.connect(e).insert(t).then(function(e){t._rev=e.rev,n(t)},r)},r):r(i)})})}},{key:"chunkUpdate",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;return new o(function(r,i){var u=[];s.chunk(t,n).forEach(function(t){u.push(new o(function(n,r){c.connect(e).bulk({docs:t}).then(n,r)}))}),o.all(u).then(r,i)})}},{key:"groupEntities",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r={entities:[]};return e.forEach(function(e){(!e.groupBefore||r.entities.length>=t)&&(r={entities:[]}),r.entities.push(e),(!e.groupAfter||r.entities.length>=t)&&(r.ratio=0,r.entities.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.entities.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n}},{key:"now",value:function(){return(0,r.default)(new Date).replace(/"/g,"")}},{key:"replace",value:function(e,t,n){return e.map(function(e){return e[n]===t[n]?t:e})}}]),e}();e.exports=l},function(e,t){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,t){e.exports=require("mjml-core")},function(e,t){e.exports=require("request-promise")},function(e,t,n){"use strict";var r=a(n(21)),i=a(n(1)),u=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var s=n(2),o=[{type:"attachment",name:"Attachment",dataType:null},{type:"audio",name:"Audio",dataType:null},{type:"checkbox",name:"Checkbox",dataType:"boolean"},{type:"color",name:"Color",dataType:"string"},{type:"date",name:"Date",dataType:"string"},{type:"embedly",name:"Embedly",dataType:null},{type:"entity",name:"Entity",dataType:"array"},{type:"entityGrid",name:"Entity Grid",dataType:"array"},{type:"entityTile",name:"Entity Tile",dataType:"array"},{type:"image",name:"Image",dataType:null},{type:"keyValue",name:"Key Value",dataType:null},{type:"number",name:"Number",dataType:"number"},{type:"richText",name:"Rich Text",dataType:null},{type:"select",name:"Select",dataType:"array"},{type:"taxonomy",name:"Taxonomy",dataType:null},{type:"text",name:"Text",dataType:"string"},{type:"textArea",name:"Text Area",dataType:"string"},{type:"video",name:"Video",dataType:null},{type:"vimeo",name:"Vimeo",dataType:null}],c=function(){function e(){(0,i.default)(this,e)}return(0,u.default)(e,null,[{key:"fields",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"field",value:function(t){return s.find(e.fields(),{type:t})}}]),e}();e.exports=c},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(3),l=n(6),d=n(12),f=function(){function e(t){return(0,u.default)(this,e),this.config=t,this}return(0,a.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).schemas.push(t),e.next=7,this.updateEntityIndex(i.schemas);case 7:return e.abrupt("return",n.set(i));case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,u=o.find(i.schemas,{slug:t})){e.next=7;break}throw Error("Schema not found: "+t);case 7:return e.abrupt("return",u);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(u=o.findIndex(i.schemas,{slug:t.slug}))){e.next=7;break}throw Error("Schema not found: "+t.slug);case 7:return i.schemas.splice(u,1,t),e.next=10,this.updateEntityIndex(i.schemas);case 10:return e.abrupt("return",n.set(i));case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return i=e.sent,t=o.isArray(t)?t:[t],i.schemas=i.schemas.filter(function(e){return-1===t.indexOf(e.slug)}),i.schemas=i.schemas.map(function(e){return e.fields?(e.fields=e.fields.map(function(e){return e.settings?(e.settings.schemas&&(e.settings.schemas=e.settings.schemas.filter(function(e){return-1===t.indexOf(e)})),e):e}),e):e}),e.next=9,this.updateEntityIndex(i.schemas);case 9:return e.abrupt("return",n.set(i));case 10:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateAll",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).schemas=t,e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"updateEntityIndex",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=[],t.forEach(function(e){n=n.concat(e.fields)}),n=o.uniqBy(n,"slug"),i={name:"entity",type:"text",ddoc:"entityIndex",index:{default_field:{enabled:!0,analyzer:"standard"},selector:{$and:[{type:"entity"}]},fields:[{name:"published",type:"boolean"},{name:"trashed",type:"boolean"},{name:"title",type:"string"},{name:"slug",type:"string"},{name:"schema",type:"string"},{name:"modifiedAt",type:"string"},{name:"publishedAt",type:"string"}]}},n.forEach(function(e){var t=d.field(e.type);/number|string|boolean/.test(t.dataType)&&i.index.fields.push({name:"fields."+e.slug+".value",type:t.dataType}),/array/.test(t.dataType)&&i.index.fields.push({name:"fields."+e.slug+".value.[].slug",type:"string"}),/taxonomy/.test(e.type)&&i.index.fields.push({name:"fields."+e.slug+".value.terms.[].slug",type:"string"})}),e.next=7,l.connect(this.config).index(i);case 7:return u=e.sent,e.abrupt("return",u);case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t,n){"use strict";var r=o(n(9)),i=o(n(5)),u=o(n(4)),a=o(n(1)),s=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(7),d=n(42),f=n(41).diff,p=n(3),h=n(6),g=n(8),v=n(13),m=n(25),y=function(){function e(t){(0,a.default)(this,e),this.config=t,this.flattenValues=e.flattenValues}return(0,s.default)(e,[{key:"fieldValues",value:function(){var e=(0,u.default)(i.default.mark(function e(t,n){var r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.connect(this.config).viewWithList("entity","byField","search",{startkey:[t],endkey:[t,{}],group:!0,searchTerm:n});case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"_entitiesById",value:function(){var t=(0,u.default)(i.default.mark(function t(){var n,r,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"guest";return i.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n={include_docs:!0},u.length&&(n.keys=u),t.next=4,h.connect(this.config).view("entity",a?"byIdExtended":"byId",n);case 4:return r=t.sent,r=e._appendParents(r,a,s),t.abrupt("return",r);case 7:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_getDocMap",value:function(){var t=(0,u.default)(i.default.mark(function t(n,r,u,a){var s,o,l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},d=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return i.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(u||r){t.next=2;break}return t.abrupt("return",l);case 2:if(s=[],n.forEach(function(t){var n=!!t.doc,i=n?t.doc:t;r&&i.fields&&c.size(i.fields)&&(c.isArray(r)?r[d].split(/,(?![^([]*[\])])/g).forEach(function(t){s=s.concat(c.flatten(e._query(i,t,!0).value).map(function(e){return e&&e.id}))}):c.forEach(i.fields,function(e){c.isArray(e.value)&&(e.value=e.value.filter(function(e){return e}),e.value.forEach(function(e){e.id&&s.push(e.id)}))}));var u=n?t.id:i._id||i.id;l[u]||s.push(u)}),0!==(s=(s=c.uniq(s)).filter(function(e){return!l[e]})).length){t.next=8;break}return t.abrupt("return",l);case 8:return t.next=10,this._entitiesById(s,u,a);case 10:if(t.t0=function(e){return e.doc},(o=t.sent.rows.map(t.t0)).forEach(function(e){l[e._id]=e}),d+=1,r&&!(d>=e._childDepthLimit(r))){t.next=16;break}return t.abrupt("return",l);case 16:return t.next=18,this._getDocMap(o,r,u,a,l,d);case 18:return l=t.sent,o=null,t.abrupt("return",l);case 21:case"end":return t.stop()}},t,this)}));return function(e,n,r,i){return t.apply(this,arguments)}}()},{key:"_extendDocs",value:function(){var t=(0,u.default)(i.default.mark(function t(n,r,u,a){var s;return i.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getDocMap(n,r,u,a);case 2:return s=t.sent,n=e._mergeDocs(n,s,r),s=null,t.abrupt("return",n);case 6:case"end":return t.stop()}},t,this)}));return function(e,n,r,i){return t.apply(this,arguments)}}()},{key:"_removeChildren",value:function(e){var t=this;return new l(function(n,r){0!==e.length?(e=e.map(function(e){return e._id}),h.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(i){var u=c.uniqBy(i.rows,function(e){return e.doc._id}).map(function(t){return t.doc.fields=c.mapValues(t.doc.fields,function(t){return c.isArray(t.value)&&(t.value=c.remove(t.value,function(t){return"entity"===t.type&&-1!==e.indexOf(t.id)})),t}),t.doc});0!==u.length?g.chunkUpdate(t.config,u,1e3).then(n,r):n([])},r)):n([])})}},{key:"_updateChildren",value:function(e){var t=this;return new l(function(n,r){if(0!==e.length){var i={};e=e.map(function(e){return i[e._id]=e,e._id}),h.connect(t.config).view("entity","byChildren",{keys:e,include_docs:!0}).then(function(e){var u=e.rows.map(function(e){var t=e.doc;return c.forEach(t.fields,function(e,n){c.isArray(e.value)&&(t.fields[n].value=e.value.map(function(e){return"entity"===e.type&&i[e.id]&&(e.slug=i[e.id].slug,e.title=i[e.id].title,e.schema=i[e.id].schema,e.published=i[e.id].published,i[e.id].thumbnail?e.thumbnail=i[e.id].thumbnail:e.thumbnail=null),e}))}),t});g.chunkUpdate(t.config,u,1e3).then(n,r)},r)}else n([])})}},{key:"entityList",value:function(){var e=(0,u.default)(i.default.mark(function e(){var t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._entitiesById(r,a,s);case 2:if(t=e.sent,(u||a)&&0!==t.total_rows){e.next=5;break}return e.abrupt("return",t.rows);case 5:return e.next=7,this._extendDocs(t.rows,u,a,s);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"_entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(a,s){e.limit=Math.min(e.limit||200,200),e.sort=c.isString(e.sort)?'"'+e.sort+'"':e.sort,t&&(e.include_docs=!0),e.include_fields||(e.include_fields=[]),c.isArray(e.include_fields)&&(e.include_fields=(0,r.default)(e.include_fields)),e.sort||delete e.sort,e.bookmark||delete e.bookmark,e.index||delete e.index,e.group_field||delete e.group_field,h.connect(n.config).search("entity",e.index||"all",e).then(function(e){if(e.groups){var r=[];return e.groups=e.groups.map(function(e){return r.push(new l(function(r,a){(t||i)&&0!==e.total_rows?n._extendDocs(e.hits,t,i,u).then(function(t){e.hits=t,r()},a):r()})),e}),void l.all(r).then(function(){a(e)},s)}(t||i)&&0!==e.total_rows?n._extendDocs(e.rows,t,i,u).then(function(t){e.rows=t,a(e)},s):a(e)},s)})}},{key:"entitySearch",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return new l(function(u,a){var s=e.limit||25;if(s<=200)n._entitySearch(e,t,r,i).then(u,a);else{var o=[],l=[];(function n(d){var f=this,p=c.clone(e);d&&(p.bookmark=d),this._entitySearch(p,t,r,i).then(function(e){e.rows&&(o=o.concat(e.rows)),e.groups&&(l=l.concat(e.groups)),o.length<e.total_rows&&o.length<s?n.call(f,e.bookmark):(e.rows=o,e.groups=l,u(e))},a)}).call(n)}})}},{key:"entityFind",value:function(){var e=(0,u.default)(i.default.mark(function e(t){var n,r,u,a,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"guest";return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0,e.prev=1,e.next=4,h.connect(this.config).find(t);case 4:n=e.sent,e.next=20;break;case 7:if(e.prev=7,e.t0=e.catch(1),"no_usable_index"!==e.t0.error){e.next=20;break}return r=new p(this.config),e.next=13,r.get();case 13:return u=e.sent,a=new v(this.config),e.next=17,a.updateEntityIndex(u.schemas);case 17:return e.next=19,h.connect(this.config).find(t);case 19:n=e.sent;case 20:if(!1!==s){e.next=22;break}return e.abrupt("return",n);case 22:if(!t.fields||-1!==t.fields.indexOf("_id")){e.next=24;break}throw new Error("_id field required for `children`");case 24:return e.next=26,this._extendDocs(n.docs,s,o,c);case 26:return n.docs=e.sent,e.abrupt("return",n);case 28:case"end":return e.stop()}},e,this,[[1,7]])}));return function(t){return e.apply(this,arguments)}}()},{key:"entityRevisions",value:function(t){var n=this;return new l(function(i,u){h.connect(n.config).get(t,{revs_info:!0}).then(function(a){var s=[];a._revs_info.forEach(function(e){"available"===e.status&&s.push(e.rev)}),h.connect(n.config).get(t,{open_revs:(0,r.default)(s)}).then(function(t){var r=[],a=[];t.forEach(function(e){e.ok&&(r.push(e.ok),c.forEach(e.ok.fields,function(e){/entity/.test(e.type)&&c.forEach(e.value,function(e){e.id&&a.push(e.id)})}))}),h.connect(n.config).fetch({keys:c.uniq(a),include_docs:!0}).then(function(t){var n={};t.rows.forEach(function(e){try{n[e.doc._id]=e.doc}catch(e){console.error("Error: child no longer exists")}}),i(e._appendChildren(r,n))},u)},u)},u)})}},{key:"entityCreate",value:function(e){var t=this;return new l(function(n,r){e.type="entity",h.connect(t.config).insert(e).then(function(t){e._id=t.id,e._rev=t.rev,n(e)},r)})}},{key:"entityRead",value:function(e){var t=this;return new l(function(n,r){h.connect(t.config).get(e).then(n,r)})}},{key:"entityUpdate",value:function(e,t){var n=this;return new l(function(r,i){var u={},a=(e=c.isArray(e)?e:[e]).map(function(e){var t=void 0;return c.isObject(e)&&(t=e._id,u[t]=e),c.isString(e)&&(t=e),t});h.connect(n.config).fetch({keys:a,include_docs:!0}).then(function(e){var s=[],o=e.rows.map(function(e){var n=e.doc,r=u[n._id],i=n;r&&(delete r._rev,f(n,r).forEach(function(e){/slug|title|thumbnail/.test(e.path[0])&&-1===s.indexOf(r)&&-1!==a.indexOf(r._id)&&s.push(r)}),i=c.mergeWith({},n,r,function(e,t){if(c.isArray(e)&&c.isArray(t))return t}));return t&&(i.trashed=!1),i});n._updateChildren(s).then(function(){g.chunkUpdate(n.config,o,1e3).then(r,i)},i)},i)})}},{key:"entityDelete",value:function(){var t=(0,u.default)(i.default.mark(function t(n){var r,u,a,s,o,l=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return i.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r=void 0,u=void 0,"trashed"!==n){t.next=9;break}return l=!0,t.next=6,h.connect(this.config).view("entity","trashed",{include_docs:!0});case 6:r=t.sent.rows,t.next=12;break;case 9:return t.next=11,h.connect(this.config).fetch({keys:c.isArray(n)?n:[n],include_docs:!0});case 11:r=t.sent.rows;case 12:if(r=(r=r.filter(function(e){return!e.value||!e.value.deleted})).map(function(e){return e.doc}),!l){t.next=26;break}return t.next=17,this._removeChildren(r);case 17:if(!(a=e._fileNames(r)).length){t.next=23;break}return s=new m(this.config),t.next=22,s.deleteFiles(a);case 22:u=t.sent;case 23:r=r.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),t.next=27;break;case 26:r=r.map(function(e){return e.trashed=!0,e});case 27:return t.next=29,g.chunkUpdate(this.config,r,1e3);case 29:return o=t.sent,t.abrupt("return",{entities:o,files:u});case 31:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()}],[{key:"flattenValues",value:function(t){return t.map(function(t){return t.fields&&c.size(t.fields)?(t.fields=c.mapValues(t.fields,function(t){return/entity/.test(t.type)&&c.isArray(t.value)&&(t.value=e.flattenValues(t.value)),t.value}),t):t})}},{key:"filterEntityFields",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"guest",n=c.isArray(e);return e=(n?e:[e]).map(function(e){return c.size(e.fields)&&(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&(!e.type||"entity"!==e.type||"guest"!==t||(void 0===e.published||e.published))})),e})),e}),n?e:e[0]}},{key:"_appendChildren",value:function(e,t){return e.map(function(e){return c.size(e.fields)?(e.fields=c.mapValues(e.fields,function(e){return c.isArray(e.value)&&(e.value=e.value.filter(function(e){return!!e&&("entity"!==e.type||void 0!==t[e.id])}),e.value=e.value.map(function(e){return"entity"===e.type&&(e=c.merge(e,t[e.id])),e=c.omitBy(e,function(e,t){return t.startsWith("_")})})),e}),e):e})}},{key:"_appendParents",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"guest",i={};return t.rows.forEach(function(e){e.doc&&"entity"===e.value.type&&(n&&(e.doc.parents=[]),i[e.id]=e.doc)}),n&&(t.rows.forEach(function(t){t.doc&&"parent"===t.value.type&&i[t.key].parents.push(e.filterEntityFields(t.doc,r))}),i=c.mapValues(i,function(e){return e.parents=c.uniqBy(e.parents,function(e){return e._id}),e})),i=null,t}},{key:"_fileNames",value:function(e){var t=[];return e.forEach(function(e){c.forEach(e.fields,function(e){e.value&&e.value.file&&t.push(e.value.file.name)})}),c.uniq(t)}},{key:"_query",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.trim().split(/\[|\]/),i="fields."+r[0]+".value["+(r[1]||"*")+"]",u=/\]:/.test(t)?":"+t.split(/\]:/).slice(-1)[0].trim():"";return d(""+i+u,{data:e,locals:{slice:function(e,t,n){return c.slice(e,t,n)},sample:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return c.sampleSize(e,t)},group:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=[],r=[];return e.forEach(function(e){(!e.groupBefore||r.length>=t)&&(r=[]),r.push(e),(!e.groupAfter||r.length>=t)&&(r.ratio=0,r.forEach(function(e){r.ratio+=(e.thumbnail||e).ratio}),r.forEach(function(e){e.groupRatio=(e.thumbnail||e).ratio/r.ratio}),n.push(r))}),n},pick:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return c.map(e,function(e){var t={};return n&&e.id&&(t.id=e.id),r.forEach(function(n){c.set(t,n,c.get(e,n))}),t})}},allowRegexp:!0})}},{key:"_childDepthLimit",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return c.isNumber(e)?e:c.isArray(e)?t?e.length+1:e.length:1}},{key:"_mergeDocs",value:function(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return r&&i+1>=e._childDepthLimit(r,!0)?t:t=t.map(function(t){var u=!!t.doc,a=u?t.doc:t;if(!a.fields&&n[t.id||t._id]&&(a=n[t.id||t._id]),r&&a.fields&&c.size(a.fields)){var s=void 0;c.isArray(r)&&(s={},r[i].split(/,(?![^([]*[\])])/g).forEach(function(e){var t=(e=e.trim()).split(/\[|\]/)[0];s[t]=e})),a.fields=c.mapValues(a.fields,function(t,u){return c.isArray(t.value)&&(t.value=t.value.filter(function(e){return e}),(!s||s&&s[u])&&(s&&s[u]&&(t.value=t.value.filter(function(e){return e.id&&n[e.id]})),t.value=t.value.map(function(e){return e&&e.id&&n[e.id]&&(e=c.merge(e,n[e.id]||{}),e=c.omitBy(e,function(e,t){return t.startsWith("_")})),e}),t.value=e._mergeDocs(t.value,n,r,i+1))),t}),a.fields=c.mapValues(a.fields,function(t,n){return c.isArray(t.value)&&s&&s[n]&&(t.value=c.flatten(e._query(a,s[n]).value)),t})}return u?t.doc=a:t=a,t})}}]),e}();e.exports=y},function(e,t){e.exports=require("mjml-core/lib/helpers/widthParser")},function(e,t){e.exports=require("babel-runtime/helpers/inherits")},function(e,t){e.exports=require("babel-runtime/helpers/possibleConstructorReturn")},function(e,t){e.exports=require("babel-runtime/core-js/object/get-prototype-of")},function(e,t){e.exports=require("fs")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(26),s=n(19),o=n(2),c=n(7),l=n(61),d=c.promisifyAll(n(60)),f=n(59),p=n(58),h=n(57).Inky,g=n(56),v=n(10).registerComponent,m=n(55).registerDependencies,y=n(54),b=n(53),x=n(52),_=n(51),w=n(3),k=n(8),A=n(50),E=n(46),T=function(){function e(t){(0,r.default)(this,e),this.config=t,this.inky=new h,v(A),v(E),m({"mc-section":["mj-column","mj-group","mj-raw"],"mj-column":["mc-image"],"mj-hero":["mc-image"]})}return(0,i.default)(e,[{key:"getTemplate",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new c(function(i,u){r=o.merge({},{preview:!1,inky:!1,mjml:!1,skipValidation:!1},r);var c=a.resolve(n.config.email.templatesPath,e),l="pug";s.existsSync(c+"/html.ejs")&&(l="ejs");var d=_.renderSync({file:a.resolve(c,"style.scss"),sourceMapContents:r.preview,sourceMapEmbed:r.preview}).css.toString().replace(/"/g,"'"),f=new p({views:{root:n.config.email.templatesPath,options:{extension:l}},juice:!r.preview,juiceResources:{preserveMediaQueries:!0,preserveFontFaces:!0,removeStyleTags:!1,removeLinkTags:!1,preserveImportant:!0,webResources:{links:!1,scripts:!1,images:!1}},transport:{jsonTransport:!0}}),h=new w(n.config),v=new k(n.config);h.get().then(function(a){t=o.merge({},t,{config:o.pick(a,["client","assets"]),helpers:v,style:d,moment:b,countries:x,template:e,preview:r.preview}),f.render(e+"/html",t).then(function(e){if(r.mjml){var t=g(e,{level:r.skipValidation?"skip":"soft"});if(t.errors&&t.errors.length)return void u(t.errors);e=t.html}r.inky&&(e=n.inky.releaseTheKraken(e)),i({html:e,text:y.fromString(e)})},u)},u)})}},{key:"sendEmail",value:function(e,t,n,r){var i=this;return new c(function(u,a){var s=l.createTransport(f({auth:{api_key:i.config.mailgun.apiKey,domain:i.config.mailgun.domain}}));i.getTemplate(t,n,r).then(function(t){e.html=t.html,e.text=t.text,s.sendMail(e,function(t,n){t?a(t):u({metadata:n,email:e})})},a)})}},{key:"subscribe",value:function(e,t,n){var r=this;return new c(function(i,u){new w(r.config).get().then(function(r){if("createsend"===t){if(r.provider.createsend){var a=new d({apiKey:r.provider.createsend.clientApiKey});return void c.promisifyAll(a.subscribers).addSubscriberAsync(n,{EmailAddress:e.email,Name:e.name,Resubscribe:!0,RestartSubscriptionBasedAutoresponders:!0}).then(function(e){i("Email.subscribe(): "+e.emailAddress)}).catch(function(e){u(e.Message)})}u(new Error("Subscriber list not configured"))}},u)})}}]),e}();e.exports=T},function(e,t){e.exports=require("babel-runtime/core-js/object/freeze")},function(e,t,n){"use strict";var r=a(n(21)),i=a(n(1)),u=a(n(0));function a(e){return e&&e.__esModule?e:{default:e}}var s=n(2),o=[{name:"Admin",slug:"admin",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!0,settings:!0,tools:!0,ecommerce:!0}},{name:"Editor",slug:"editor",permissions:{entityGrid:!0,entityCreate:!0,entityRead:!0,entityUpdate:!0,entityDelete:!0,taxonomyCreate:!0,taxonomyRead:!0,taxonomyUpdate:!0,taxonomyDelete:!0,fileCreate:!0,fileRead:!0,fileUpdate:!0,fileDelete:!0,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}},{name:"Guest",slug:"guest",permissions:{entityGrid:!0,entityCreate:!1,entityRead:!0,entityUpdate:!1,entityDelete:!1,taxonomyCreate:!1,taxonomyRead:!0,taxonomyUpdate:!1,taxonomyDelete:!1,fileCreate:!1,fileRead:!0,fileUpdate:!1,fileDelete:!1,config:!1,schema:!1,user:!1,settings:!1,tools:!1,ecommerce:!1}}],c=function(){function e(){(0,i.default)(this,e)}return(0,u.default)(e,[{key:"roles",value:function(){return o.map(function(e){return(0,r.default)(e)})}},{key:"role",value:function(e){return s.find(this.roles(),{slug:e})}}]),e}();e.exports=c},function(e,t){e.exports=require("@cloudant/cloudant")},function(e,t){e.exports=require("axios")},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(24),l=n(65),d=n(3),f=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,a.default)(e,[{key:"deleteFiles",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u,a;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new d(this.config),e.next=3,n.get();case 3:if(i=e.sent,u=o.get(i,"assets.slug",this.config.slug),0!==t.length){e.next=7;break}return e.abrupt("return",[]);case 7:return e.next=9,c.post(this.config.assist.url+"/"+u+"/file/delete",{fileNames:t},{auth:{username:this.config.assist.username,password:l.generate(this.config.assist.password)}});case 9:return a=e.sent.data,e.abrupt("return",a);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=f},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(3),l=function(){function e(t){return(0,u.default)(this,e),this.config=t,this}return(0,a.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).users.push(t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,u=o.find(i.users,{id:t})){e.next=7;break}throw Error("User not found: "+t);case 7:return e.abrupt("return",u);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(u=o.findIndex(i.users,{id:t.id}))){e.next=7;break}throw Error("User not found: "+t.id);case 7:return i.users.splice(u,1,t),e.abrupt("return",n.set(i));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return i=e.sent,t=o.isArray(t)?t:[t],i.users=i.users.filter(function(e){return-1===t.indexOf(e.id)}),e.abrupt("return",n.set(i));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(7).promisifyAll(n(19)),c=n(23),l=n(6),d=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,a.default)(e,[{key:"getDb",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).fetch({include_docs:!0});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"getChanges",value:function(){var e=(0,i.default)(r.default.mark(function e(){var t;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,l.connect(this.config).changes({limit:50,include_docs:!0,filter:"tools/changesEntity"});case 2:return t=e.sent,e.abrupt("return",t);case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"importDb",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u,a,s;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.config.db.name,e.next=3,o.readFileAsync(t.path);case 3:return i=e.sent,u=JSON.parse(i).rows.map(function(e){var t=e.doc;return delete t._rev,t}),e.next=7,o.unlinkAsync(t.path);case 7:return a=new c({url:this.config.db.url,plugins:["promises","retry"]}).db,e.prev=8,e.next=11,a.destroy(n);case 11:e.next=15;break;case 13:e.prev=13,e.t0=e.catch(8);case 15:return e.next=17,a.create(n);case 17:return e.next=19,l.connect(this.config,n).bulk({docs:u});case 19:return s=e.sent,e.abrupt("return",s);case 21:case"end":return e.stop()}},e,this,[[8,13]])}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(6),l=n(3),d=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,a.default)(e,[{key:"create",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return(i=e.sent).taxonomies.push(t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"read",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(i=e.sent,u=o.find(i.taxonomies,{slug:t})){e.next=7;break}throw Error("Taxonomy not found: "+t);case 7:return e.abrupt("return",u);case 8:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:if(i=e.sent,-1!==(u=o.findIndex(i.taxonomies,{slug:t.slug}))){e.next=7;break}throw Error("Taxonomy not found: "+t.slug);case 7:return i.taxonomies.splice(u,1,t),e.abrupt("return",n.set(i));case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"delete",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new l(this.config),e.next=3,n.get();case 3:return i=e.sent,t=o.isArray(t)?t:[t],i.taxonomies=i.taxonomies.filter(function(e){return-1===t.indexOf(e.slug)}),e.abrupt("return",n.set(i));case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"entitiesByTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.connect(this.config),e.next=3,n.view("entity","byTaxonomyTerm",{keys:[t.id],group:!0});case 3:if(e.t0=function(e){return e.value},i=e.sent.rows.map(e.t0)[0]){e.next=7;break}return e.abrupt("return",[]);case 7:return u=[],o.forEach(i,function(e){u=u.concat(e)}),u=o.uniq(u),e.next=12,n.fetch({keys:u,include_docs:!0});case 12:return e.t1=function(e){return e.doc},e.abrupt("return",e.sent.rows.map(e.t1));case 14:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"createTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.read(t);case 2:return(i=e.sent).terms.push(n),e.abrupt("return",this.update(i));case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e.parents||(e.parents=[]),e.parents=e.parents.map(function(e){return e.id===t.id&&(e.title=t.title,e.slug=t.slug),e}),e})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"deleteTerm",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.entitiesByTerm(t);case 2:return n=(n=e.sent).map(function(e){return e.fields=o.mapValues(e.fields,function(e){return"taxonomy"===e.type&&e.value&&(e.value.terms||(e.value.terms=[]),e.value.terms=e.value.terms.filter(function(e){return e.id!==t.id&&!(e.parents||[]).filter(function(e){return e.id===t.id}).length})),e}),e}),e.abrupt("return",c.connect(this.config).bulk({docs:n}));case 5:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=d},function(e,t){e.exports=require("hashids")},function(e,t){e.exports=require("stripe")},function(e,t,n){"use strict";var r=o(n(9)),i=o(n(5)),u=o(n(4)),a=o(n(1)),s=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var c=n(2),l=n(31),d=n(7),f=n(30),p=n(3),h=n(20),g=n(6),v=n(8),m=function(){function e(t){(0,a.default)(this,e),this.config=t,this.stripe=l(this.config.stripe.apiKey),this.email=new h(this.config),this.hashids=new f(this.config.slug,6,"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ")}return(0,s.default)(e,[{key:"getSettings",value:function(){var e=(0,u.default)(i.default.mark(function e(){var t,n,r;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=new p(this.config),e.next=3,t.get();case 3:n=e.sent,r=void 0,e.prev=5,r=n.module.ecommerce,e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(5),new Error(e.t0);case 12:e.prev=12,r.clientStripeAccountId=n.provider.stripe.stripe_user_id,e.next=19;break;case 16:throw e.prev=16,e.t1=e.catch(12),new Error(e.t1);case 19:return r.client=n.client,r.assets=n.assets,e.abrupt("return",r);case 22:case"end":return e.stop()}},e,this,[[5,9],[12,16]])}));return function(){return e.apply(this,arguments)}}()},{key:"checkout",value:function(e,t){var n=this;return new d(function(r,i){n.getSettings().then(function(u){var a=c.get(u,"createsend.checkoutSubscriberListId");t.subscribe&&a&&n.email.subscribe(t.customerDetails,"createsend",a).then(function(e){console.log(e)},function(e){console.error(e)}),n.findOrCreateCustomer(t.customerDetails.email,t).then(function(a){n.createOrder(t,a).then(function(t){n.updateOrCreateStripeCustomer(u.clientStripeAccountId,a,e,t).then(function(e){n.updateCustomer(a,e,t).then(function(a){n.createCharge(u,e,a,t).then(function(e){n.sendReceipt(u,a,t).then(function(s){e.messages.orderReceipt=s,n.sendNotification(u,a,t).then(function(t){e.messages.orderNotification=t,n.updateOrder(e).then(function(e){r(e)},i)},i)},i)},i)},i)},i)},i)},i)},i).catch(i)})}},{key:"retrieveAccount",value:function(){var e=this;return new d(function(t,n){e.getSettings().then(function(r){e.stripe.accounts.retrieve(r.clientStripeAccountId).then(t,n)},n)})}},{key:"refund",value:function(e,t){var n=this;return new d(function(r,i){n.getSettings().then(function(u){n.stripe.refunds.create({refund_application_fee:!0,charge:e.charge.id,amount:t},{stripe_account:u.clientStripeAccountId}).then(function(t){n.stripe.charges.retrieve(e.charge.id,{stripe_account:u.clientStripeAccountId}).then(function(t){e.charge.status=t.status,e.charge.amount=t.amount,e.charge.amountRefunded=t.amount_refunded,v.createOrUpdate(n.config,e).then(r,i)},i)},i)},i)})}},{key:"findOrCreateCustomer",value:function(e,t){var n=this;return new d(function(i,u){g.connect(n.config).view("ecommerce","customerByEmail",{keys:[e],include_docs:!0}).then(function(e){if(e.rows.length)i(e.rows[0].doc);else{var a=(0,r.default)(new Date).replace(/"/g,""),s={type:"customer",createdAt:a,modifiedAt:a,email:t.customerDetails.email,name:t.customerDetails.name,phone:t.customerDetails.phone,billingAddress:t.billingAddress,shippingAddress:t.shippingAddress,orders:[]};g.connect(n.config).insert(s).then(function(e){s._id=e.id,s._rev=e.rev,i(s)},u)}},u)})}},{key:"updateOrCreateStripeCustomer",value:function(e,t,n,r){var i=this;return new d(function(u,a){var s={source:n,email:r.customer.email,description:r.customer.name,metadata:{customer_id:t._id}};t.stripe&&t.stripe.customer.id?i.stripe.customers.update(t.stripe.customer.id,s,{stripe_account:e}).then(u,function(t){"StripeInvalidRequestError"===t.type&&"id"===t.param?i.stripe.customers.create(s,{stripe_account:e}).then(u,a):a(t)}):i.stripe.customers.create(s,{stripe_account:e}).then(u,a)})}},{key:"createOrder",value:function(e,t){var n=this;return new d(function(i,u){var a=e.items.map(function(e){return{id:e.id,title:e.title.replace(/<br\s?>/gi," ").replace(/<\/?p>|<\/?span>/gi,""),price:e.price,quantity:e.quantity,metadata:e.metadata||{}}}),s=(0,r.default)(new Date).replace(/"/g,""),o={type:"order",orderId:n.hashids.encode((new Date).getTime()),createdAt:s,modifiedAt:s,customer:{id:t._id,email:t.email,name:t.name},items:a,shippingMethod:{name:e.shippingMethod.name,amount:Number(e.shippingMethod.amount)},subtotal:Number(e.subtotal),tax:{rate:e.tax.rate||0,includedInPrice:e.tax.includedInPrice||!1,total:e.tax.total||0,show:e.tax.show||!1},discount:{code:e.discount.code||"",name:e.discount.name||"",total:e.discount.total||0},total:Number(e.total),billingAddress:e.billingAddress,shippingAddress:e.shippingAddress,messages:{},status:"pending",test:!0};g.connect(n.config).insert(o).then(function(e){o._id=e.id,o._rev=e.rev,i(o)},u)})}},{key:"updateOrder",value:function(e){var t=this;return new d(function(n,r){g.connect(t.config).insert(e).then(function(t){e._rev=t.rev,n(e)},r)})}},{key:"updateCustomer",value:function(e,t,n){var i=this;return new d(function(u,a){var s=(0,r.default)(new Date).replace(/"/g,"");e.modifiedAt=s,e.orders||(e.orders=[]),e.orders.push(n._id),e.stripe||(e.stripe={customer:{id:null}}),e.stripe.customer.id=t.id,g.connect(i.config).insert(e).then(function(t){e._rev=t.rev,u(e)},a)})}},{key:"createCharge",value:function(e,t,n,r){var i=this;return new d(function(u,a){var s=100*Number(r.total),o={amount:s,currency:e.currency.iso.toLowerCase(),customer:t.id,capture:!0,description:r.orderId,metadata:{customer_id:n._id,order_id:r._id},statement_descriptor:c.kebabCase(e.storeName).toUpperCase(),application_fee:Math.ceil(.02*s)};i.stripe.charges.create(o,{stripe_account:e.clientStripeAccountId}).then(function(e){r.charge={paymentGateway:"stripe",id:e.id,status:e.status,currency:e.currency.toUpperCase(),amount:e.amount,amountRefunded:e.amount_refunded},r.test=!e.livemode,u(r)},a)})}},{key:"sendReceipt",value:function(e,t,n){var r=this;return new d(function(i,u){var a={settings:e,order:n},s={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:t.email,subject:"Your order at "+e.storeName+" ("+n.orderId+")"},o=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(s,o+"/order-receipt",a).then(i,u)})}},{key:"sendNotification",value:function(e,t,n){var r=this;return new d(function(t,i){var u={settings:e,order:n},a={from:e.emailSenderName+" <"+e.emailSenderAddress+">",to:e.emailSenderAddress,subject:"New order at "+e.storeName+" ("+n.orderId+")"},s=c.get(e,"assets.slug",r.config.slug);r.email.sendEmail(a,s+"/order-notification",u).then(t,i)})}}]),e}();e.exports=m},function(e,t){e.exports=require("shippo")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(7),s=n(33),o=function(){function e(t){(0,r.default)(this,e),this.config=t,this.shippo=s(t.shippo.token)}return(0,i.default)(e,[{key:"getQuote",value:function(e,t){var n=this;return new a(function(r,i){var u={object_purpose:"QUOTE",zip:n.config.shippo.fromZip,country:n.config.shippo.fromCountry},a={object_purpose:"QUOTE",zip:e.zip,country:e.country,metadata:""};t.distance_unit="cm",t.mass_unit="kg",n.shippo.shipment.create({object_purpose:"QUOTE",address_from:u,address_to:a,parcel:t}).then(function(e){!function e(t,u){("QUEUED"===t.object_status||"WAITING"===t.object_status)&&u<10?n.shippo.shipment.retrieve(t.object_id).then(function(t){e(t,u+1)}):n.shippo.shipment.rates(t.object_id).then(function(e){r(e)},function(e){console.error("There was an error retrieving rates : %s",e),i(e)})}(e,0)},function(e){console.error("There was an error creating shipment: %s",e),i(e)})})}}]),e}();e.exports=o},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(3),l=function(){function e(t){return(0,u.default)(this,e),this.config=t,this}return(0,a.default)(e,[{key:"update",value:function(){var e=(0,i.default)(r.default.mark(function e(t){var n,i;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new c(this.config),e.next=3,n.get();case 3:return(i=e.sent).client=o.merge({},i.client,t),e.abrupt("return",n.set(i));case 6:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=l},function(e,t){e.exports=require("babel-runtime/helpers/typeof")},function(e,t,n){"use strict";var r=c(n(9)),i=c(n(36)),u=c(n(5)),a=c(n(4)),s=c(n(1)),o=c(n(0));function c(e){return e&&e.__esModule?e:{default:e}}var l=n(2),d=n(11),f=n(14),p=n(3),h=function(){function e(t){(0,s.default)(this,e),this.config=t,this.templates=this.config.pdf.templates}return(0,o.default)(e,[{key:"getPayload",value:function(){var e=(0,a.default)(u.default.mark(function e(t,n,r){var i,a,s;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.templates[t]){e.next=2;break}throw new Error("Template not found");case 2:return i=new f(this.config),e.next=5,i.entityList([n],2,!1,r);case 5:if(e.t0=function(e){return e.doc},0!==(a=e.sent.map(e.t0)).length){e.next=9;break}throw new Error("Entity not found");case 9:return s=this.templates[t](f.flattenValues(a)[0]),e.abrupt("return",s);case 11:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"getPdf",value:function(){var e=(0,a.default)(u.default.mark(function e(t){var n,a,s,o,c;return u.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new p(this.config),e.next=3,n.get();case 3:return a=e.sent,s=l.get(a,"assets.slug",this.config.slug),o=this.config.assist.url+"/"+s+"/pdf/download",t="object"===(void 0===t?"undefined":(0,i.default)(t))?(0,r.default)(t).replace(/'/gi,"’"):t,e.next=9,d({method:"POST",uri:o,encoding:null,form:{payload:t}});case 9:return c=e.sent,e.abrupt("return",c);case 11:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}();e.exports=h},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(38),s=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"signToken",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a.sign(e,this.config.auth.tokenSecret,t)}},{key:"verifyToken",value:function(e){return a.verify(e,this.config.auth.tokenSecret)}}]),e}();e.exports=s},function(e,t,n){"use strict";var r=n(2),i=n(7),u=n(11);e.exports=function(e){e=r.merge({},{client_id:null,access_token:null,version:"v1",host:"https://api.instagram.com"},e||{});this.get=function(t,n){return function(t,n,a){return new i(function(i,s){var o={method:t,url:[e.host,e.version,n].join("/"),qs:{access_token:a.access_token||e.access_token,client_id:a.client_id||e.client_id}};o.qs=r.extend({},o.qs,a),u(o).then(function(e){i(JSON.parse(e))},s)})}("GET",t,n)}}},function(e,t){e.exports=require("deep-diff")},function(e,t){e.exports=require("json-query")},function(e,t){e.exports=require("embedly")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(2),s=n(7),o=n(43),c=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"oembed",value:function(e){var t=this;return new s(function(n,r){var i=new o({key:t.config.embedly.apiKey}),u={urls:a.isArray(e)?e:[e],format:"json"};i.oembed(u,function(e,t){e?r(e):n(t)})})}}]),e}();e.exports=c},function(e,t){e.exports=require("lodash/min")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i,u=p(n(18)),a=p(n(1)),s=p(n(0)),o=p(n(17)),c=p(n(16)),l=p(n(45)),d=n(10),f=p(n(15));function p(e){return e&&e.__esModule?e:{default:e}}var h=(i=r=function(e){function t(){return(0,a.default)(this,t),(0,o.default)(this,(t.__proto__||(0,u.default)(t)).apply(this,arguments))}return(0,c.default)(t,e),(0,s.default)(t,[{key:"getStyles",value:function(){var e=this.getContentWidth(),t="full-width"===this.getAttribute("full-width"),n=(0,f.default)(e),r=n.parsedWidth,i=n.unit;return{img:{border:this.getAttribute("border"),"border-radius":this.getAttribute("border-radius"),display:"block",outline:"none","text-decoration":"none","min-width":t?"100%":null,width:t?""+r+i:"100%","max-width":t?"100%":null},td:{width:t?null:""+r+i},table:{"min-width":t?"100%":null,"max-width":t?"100%":null,width:t?""+r+i:null,"border-collapse":"collapse","border-spacing":"0px"}}}},{key:"getContentWidth",value:function(){var e=this.context.containerWidth,t=this.getAttribute("width")?(0,l.default)([parseInt(this.getAttribute("width"),10),parseInt(e,10)]):parseInt(e,10),n=this.getShorthandAttrValue("padding","right"),r=this.getShorthandAttrValue("padding","left")+n+parseFloat(t)-parseInt(e,10);return r>0?parseFloat(t-r):parseFloat(t)}},{key:"renderImage",value:function(){var e="\n      <img\n        "+this.htmlAttributes({alt:this.getAttribute("alt"),height:this.getAttribute("height"),src:this.getAttribute("src"),srcset:this.getAttribute("srcset"),style:"img",title:this.getAttribute("title"),width:this.getContentWidth(),"mc:edit":this.getAttribute("mc:edit")})+"\n      />\n    ";return this.getAttribute("href")?"\n        <a\n          "+this.htmlAttributes({href:this.getAttribute("href"),target:this.getAttribute("target")})+"\n        >\n          "+e+"\n        </a>\n      ":e}},{key:"render",value:function(){return"\n      <table\n        "+this.htmlAttributes({align:this.getAttribute("align"),border:"0",cellpadding:"0",cellspacing:"0",role:"presentation",style:"table"})+"\n      >\n        <tbody>\n          <tr>\n            <td "+this.htmlAttributes({style:"td"})+">\n              "+this.renderImage()+"\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    "}}]),t}(d.BodyComponent),r.tagOmission=!0,r.allowedAttributes={"mc:edit":"string",alt:"string",href:"string",src:"string",srcset:"string",title:"string",align:"enum(left,center,right)",border:"string","border-bottom":"string","border-left":"string","border-right":"string","border-top":"string","border-radius":"unit(px,%)","container-background-color":"string",padding:"unit(px,%){1,4}","padding-bottom":"unit(px,%)","padding-left":"unit(px,%)","padding-right":"unit(px,%)","padding-top":"unit(px,%)",height:"unit(px,%)",width:"unit(px,%)"},r.defaultAttributes={align:"center",border:"0",height:"auto",padding:"10px 25px",target:"_blank"},i);t.default=h,e.exports=t.default},function(e,t){e.exports=require("lodash/fp")},function(e,t){e.exports=require("babel-runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("babel-runtime/helpers/extends")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r,i,u=g(n(49)),a=g(n(48)),s=g(n(18)),o=g(n(1)),c=g(n(0)),l=g(n(17)),d=g(n(16)),f=n(10),p=n(47),h=g(n(15));function g(e){return e&&e.__esModule?e:{default:e}}var v=(0,p.flow)((0,p.filter)(p.identity),(0,p.join)(" ")),m=(i=r=function(e){function t(){var e,n,r,i;(0,o.default)(this,t);for(var u=arguments.length,c=Array(u),d=0;d<u;d++)c[d]=arguments[d];return n=r=(0,l.default)(this,(e=t.__proto__||(0,s.default)(t)).call.apply(e,[this].concat(c))),r.getBackground=function(){return v([r.getAttribute("background-color")].concat((0,a.default)(r.hasBackground()?["url("+r.getAttribute("background-url")+")","top center / "+r.getAttribute("background-size"),r.getAttribute("background-repeat")]:[])))},i=n,(0,l.default)(r,i)}return(0,d.default)(t,e),(0,c.default)(t,[{key:"getChildContext",value:function(){var e=this.context.containerWidth,t=this.getShorthandAttrValue("padding","left")+this.getShorthandAttrValue("padding","right"),n=(0,h.default)(e,{parseFloatToInt:!1}).parsedWidth;return(0,u.default)({},this.context,{containerWidth:n-t+"px"})}},{key:"getStyles",value:function(){var e=this.context.containerWidth,t=this.isFullWidth(),n=this.getAttribute("background-url")?{background:this.getBackground()}:{background:this.getAttribute("background-color"),"background-color":this.getAttribute("background-color")};return{tableFullwidth:(0,u.default)({},t?n:{},{width:"100%","border-radius":this.getAttribute("border-radius")}),table:(0,u.default)({},t?{}:n,{width:"100%","border-radius":this.getAttribute("border-radius")}),td:{border:this.getAttribute("border"),"border-bottom":this.getAttribute("border-bottom"),"border-left":this.getAttribute("border-left"),"border-right":this.getAttribute("border-right"),"border-top":this.getAttribute("border-top"),direction:this.getAttribute("direction"),"font-size":"0px",padding:this.getAttribute("padding"),"padding-bottom":this.getAttribute("padding-bottom"),"padding-left":this.getAttribute("padding-left"),"padding-right":this.getAttribute("padding-right"),"padding-top":this.getAttribute("padding-top"),"text-align":this.getAttribute("text-align"),"vertical-align":this.getAttribute("vertical-align")},div:(0,u.default)({},t?{}:n,{Margin:"0px auto","border-radius":this.getAttribute("border-radius"),"max-width":e}),innerDiv:{"line-height":"0","font-size":"0"}}}},{key:"hasBackground",value:function(){return null!=this.getAttribute("background-url")}},{key:"isFullWidth",value:function(){return"full-width"===this.getAttribute("full-width")}},{key:"renderBefore",value:function(){var e=this.context.containerWidth;return"\n      \x3c!--[if mso | IE]>\n      <table\n        "+this.htmlAttributes({align:"center",border:"0",cellpadding:"0",cellspacing:"0",class:this.getAttribute("css-class")?this.getAttribute("css-class").split(" ").map(function(e){return e+"-outlook"}).join(" "):null,style:{width:""+e},width:parseInt(e,10)})+'\n      >\n        <tr>\n          <td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;">\n      <![endif]--\x3e\n    '}},{key:"renderAfter",value:function(){return"\n      \x3c!--[if mso | IE]>\n          </td>\n        </tr>\n      </table>\n      <![endif]--\x3e\n    "}},{key:"renderWrappedChildren",value:function(){var e=this.props.children;return"\n      \x3c!--[if mso | IE]>\n        <tr>\n      <![endif]--\x3e\n      "+this.renderChildren(e,{renderer:function(e){return e.constructor.isRawElement()?e.render():"\n          \x3c!--[if mso | IE]>\n            <td\n              "+e.htmlAttributes({align:e.getAttribute("align"),class:e.getAttribute("css-class")?e.getAttribute("css-class").split(" ").map(function(e){return e+"-outlook"}).join(" "):null,style:"tdOutlook"})+"\n            >\n          <![endif]--\x3e\n            "+e.render()+"\n          \x3c!--[if mso | IE]>\n            </td>\n          <![endif]--\x3e\n    "}})+"\n\n      \x3c!--[if mso | IE]>\n        </tr>\n      <![endif]--\x3e\n    "}},{key:"renderWithBackground",value:function(e){var t=this.isFullWidth(),n=this.context.containerWidth;return"\n      \x3c!--[if mso | IE]>\n        <v:rect "+this.htmlAttributes({style:t?{"mso-width-percent":"1000"}:{width:n},"xmlns:v":"urn:schemas-microsoft-com:vml",fill:"true",stroke:"false"})+">\n        <v:fill "+this.htmlAttributes({origin:"0.5, 0",position:"0.5, 0",src:this.getAttribute("background-url"),color:this.getAttribute("background-color"),type:"tile"})+' />\n        <v:textbox style="mso-fit-shape-to-text:true" inset="0,0,0,0">\n      <![endif]--\x3e\n          '+e+"\n        \x3c!--[if mso | IE]>\n        </v:textbox>\n      </v:rect>\n    <![endif]--\x3e\n    "}},{key:"renderSection",value:function(){var e=this.hasBackground();return"\n      <div "+this.htmlAttributes({class:this.isFullWidth()?null:this.getAttribute("css-class"),style:"div","mc:hideable":this.getAttribute("mc:hideable"),"mc:repeatable":this.getAttribute("mc:repeatable"),"mc:variant":this.getAttribute("mc:variant")})+">\n        "+(e?"<div "+this.htmlAttributes({style:"innerDiv"})+">":"")+"\n        <table\n          "+this.htmlAttributes({align:"center",background:this.isFullWidth()?null:this.getAttribute("background-url"),border:"0",cellpadding:"0",cellspacing:"0",role:"presentation",style:"table"})+"\n        >\n          <tbody>\n            <tr>\n              <td\n                "+this.htmlAttributes({style:"td"})+'\n              >\n                \x3c!--[if mso | IE]>\n                  <table role="presentation" border="0" cellpadding="0" cellspacing="0">\n                <![endif]--\x3e\n                  '+this.renderWrappedChildren()+"\n                \x3c!--[if mso | IE]>\n                  </table>\n                <![endif]--\x3e\n              </td>\n            </tr>\n          </tbody>\n        </table>\n        "+(e?"</div>":"")+"\n      </div>\n    "}},{key:"renderFullWidth",value:function(){var e=this.hasBackground()?this.renderWithBackground("\n        "+this.renderBefore()+"\n        "+this.renderSection()+"\n        "+this.renderAfter()+"\n      "):"\n        "+this.renderBefore()+"\n        "+this.renderSection()+"\n        "+this.renderAfter()+"\n      ";return"\n      <table\n        "+this.htmlAttributes({align:"center",class:this.getAttribute("css-class"),background:this.getAttribute("background-url"),border:"0",cellpadding:"0",cellspacing:"0",role:"presentation",style:"tableFullwidth"})+"\n      >\n        <tbody>\n          <tr>\n            <td>\n              "+e+"\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    "}},{key:"renderSimple",value:function(){var e=this.renderSection();return"\n      "+this.renderBefore()+"\n      "+(this.hasBackground()?this.renderWithBackground(e):e)+"\n      "+this.renderAfter()+"\n    "}},{key:"render",value:function(){return this.isFullWidth()?this.renderFullWidth():this.renderSimple()}}]),t}(f.BodyComponent),r.allowedAttributes={"mc:hideable":"boolean","mc:repeatable":"string","mc:variant":"string","background-color":"color","background-url":"string","background-repeat":"enum(repeat/no-repeat)","background-size":"string",border:"string","border-bottom":"string","border-left":"string","border-radius":"string","border-right":"string","border-top":"string",direction:"enum(ltr,rtl)","full-width":"enum(full-width)",padding:"unit(px,%){1,4}","padding-top":"unit(px,%)","padding-bottom":"unit(px,%)","padding-left":"unit(px,%)","padding-right":"unit(px,%)","text-align":"enum(left,center,right)","text-padding":"unit(px,%){1,4}","vertical-align":"enum(bottom,middle,top)"},r.defaultAttributes={"background-repeat":"repeat","background-size":"auto",direction:"ltr",padding:"20px 0","text-align":"center","text-padding":"4px 4px 4px 0","vertical-align":"top"},i);t.default=m,e.exports=t.default},function(e,t){e.exports=require("node-sass")},function(e,t){e.exports=require("i18n-iso-countries")},function(e,t){e.exports=require("moment")},function(e,t){e.exports=require("html-to-text")},function(e,t){e.exports=require("mjml-validator")},function(e,t){e.exports=require("mjml")},function(e,t){e.exports=require("inky")},function(e,t){e.exports=require("email-templates")},function(e,t){e.exports=require("nodemailer-mailgun-transport")},function(e,t){e.exports=require("createsend-node")},function(e,t){e.exports=require("nodemailer")},function(e,t,n){"use strict";var r=u(n(1)),i=u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}var a=n(2),s=n(7),o=n(6),c=n(8),l=function(){function e(t){(0,r.default)(this,e),this.config=t}return(0,i.default)(e,[{key:"getType",value:function(e,t){var n=this;return new s(function(r,i){t.sort=a.isString(t.sort)?'"'+t.sort+'"':t.sort,o.connect(n.config).search("ecommerce",e,t).then(r,i)})}},{key:"setType",value:function(e,t){var n=this;return new s(function(r,i){t.type=e,c.createOrUpdate(n.config,t).then(r,i)})}},{key:"deleteType",value:function(e){var t=this;return new s(function(n,r){e=e.map(function(e){return{_id:e._id,_rev:e._rev,_deleted:!0}}),c.chunkUpdate(t.config,e,1e3).then(n,r)})}},{key:"getOrder",value:function(e){var t=this;return new s(function(n,r){o.connect(t.config).view("ecommerce","orderByOrderId",{key:e,include_docs:!0}).then(function(e){e.rows.length?n(e.rows[0].doc):r(new Error("Order not found"))},r)})}},{key:"verifyDiscount",value:function(e){var t=this;return new s(function(n,r){o.connect(t.config).view("ecommerce","discountByCode",{keys:[e],include_docs:!0}).then(function(t){if(t.rows.length){var i=t.rows[0].doc,u=(new Date).getTime(),a=new Date(Date.parse(i.dateStart)).getTime(),s=new Date(Date.parse(i.dateEnd)).getTime();if(a>u)return void r(new Error("Discount not valid (not begun)"));if(s<u)return void r(new Error("Discount not valid (expired)"));n(i)}else r(new Error({statusCode:404,message:"Discount code not found ("+e+")"}))},r)})}}]),e}();e.exports=l},function(e,t){e.exports=require("querystring")},function(e,t,n){"use strict";var r=s(n(5)),i=s(n(4)),u=s(n(1)),a=s(n(0));function s(e){return e&&e.__esModule?e:{default:e}}var o=n(2),c=n(63),l=n(24),d=n(3),f=n(6),p={google:"https://www.googleapis.com/oauth2/v4/token",instagram:"https://api.instagram.com/oauth/access_token",stripe:"https://connect.stripe.com/oauth/token",vimeo:"https://api.vimeo.com/oauth/access_token"},h=function(){function e(t){(0,u.default)(this,e),this.config=t}return(0,a.default)(e,[{key:"authoriseUser",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i,u;return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.config.auth.superUserId.split(",").map(function(e){return e.trim()}).indexOf(n)>-1)){e.next=3;break}return e.abrupt("return",{id:n,role:"super"});case 3:return e.next=5,f.connect(this.config,t).get("config");case 5:if(i=e.sent,u=o.find(i.users,{id:n})){e.next=9;break}throw Error("User not found: "+n);case 9:if(u.active){e.next=11;break}throw Error("User not active: "+n);case 11:return e.abrupt("return",u);case 12:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"authenticateWithProvider",value:function(){var e=(0,i.default)(r.default.mark(function e(t,n){var i,u,a,s,f,h,g,v=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return r.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.merge({},this.config[t],n),u={grant_type:v?"refresh_token":"authorization_code",client_id:i.clientId,client_secret:i.clientSecret,redirect_uri:i.redirectUri,code:n.code,refresh_token:n.refresh_token},a=p[t],s=void 0,e.prev=4,e.next=7,l.post(a,c.stringify(u));case 7:s=e.sent,e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(4),new Error(e.t0.response.data.error_description);case 13:return f=new d(this.config),e.next=16,f.get();case 16:if((h=e.sent).provider||(h.provider={}),g=o.merge({},h.provider[t]||{},s.data),"google"!==t){e.next=30;break}return g.expires=g.expires_in+Math.floor(+new Date/1e3),e.prev=21,e.next=24,l.get("https://www.googleapis.com/plus/v1/people/me?access_token="+g.access_token);case 24:g.user=e.sent.data,e.next=30;break;case 27:e.prev=27,e.t1=e.catch(21),console.error(e.t1);case 30:return h.provider[t]=g,e.abrupt("return",f.set(h));case 32:case"end":return e.stop()}},e,this,[[4,10],[21,27]])}));return function(t,n){return e.apply(this,arguments)}}()}]),e}();e.exports=h},function(e,t){e.exports=require("password-hash")},function(e,t,n){"use strict";(function(t){var r=n(26),i={environment:process.env.ENVIRONMENT||"development",debug:process.env.DEBUG||!1,slug:process.env.SLUG,baseUrl:process.env.BASE_URL||"",db:{url:process.env.DB_URL,host:process.env.DB_HOST,name:process.env.DB_NAME,requestPlugin:process.env.DB_REQUEST_PLUGIN,meterType:process.env.DB_METER_TYPE},auth:{superUserId:process.env.AUTH_SUPER_USER_ID,tokenSecret:process.env.AUTH_TOKEN_SECRET||"change_this_secret"},dev:{userId:process.env.DEV_USER_ID||"dev",role:process.env.DEV_ROLE||"super"},assist:{url:process.env.ASSIST_URL,username:process.env.ASSIST_USERNAME,password:process.env.ASSIST_PASSWORD},instagram:{clientId:process.env.INSTAGRAM_CLIENT_ID,clientSecret:process.env.INSTAGRAM_CLIENT_SECRET},twitter:{consumerKey:process.env.TWITTER_CONSUMER_KEY,consumerSecret:process.env.TWITTER_CONSUMER_SECRET,accessTokenKey:process.env.TWITTER_ACCESS_TOKEN_KEY,accessTokenSecret:process.env.TWITTER_ACCESS_TOKEN_SECRET},google:{clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET},mailgun:{apiKey:process.env.MAILGUN_API_KEY,domain:process.env.MAILGUN_DOMAIN},embedly:{apiKey:process.env.EMBEDLY_API_KEY},aws:{iamAccessKeyId:process.env.AWS_IAM_ACCESS_KEY_ID,iamAccessKeySecret:process.env.AWS_IAM_ACCESS_KEY_SECRET,s3:{bucket:process.env.AWS_S3_BUCKET}},shippo:{token:process.env.SHIPPO_TOKEN,fromZip:process.env.SHIPPO_FROM_ZIP,fromCountry:process.env.SHIPPO_FROM_COUNTRY},stripe:{clientId:process.env.STRIPE_CLIENT_ID,clientSecret:process.env.STRIPE_CLIENT_SECRET,apiKey:process.env.STRIPE_API_KEY},vimeo:{clientId:process.env.VIMEO_CLIENT_ID,clientSecret:process.env.VIMEO_CLIENT_SECRET},zencoder:{apiKey:process.env.ZENCODER_API_KEY,s3:{bucket:process.env.ZENCODER_S3_BUCKET,credentials:process.env.ZENCODER_S3_CREDENTIALS}},pdf:{templates:{}},email:{templatesPath:r.resolve(t,"email")}};e.exports=i}).call(this,"/")},function(e,t,n){"use strict";function r(){}r.defaultConfig=n(66),r.Assist=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(25),[null].concat(t)))},r.Auth=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(64),[null].concat(t)))},r.ClientConfig=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(3),[null].concat(t)))},r.Db=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(6),[null].concat(t)))},r.Ecommerce=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(62),[null].concat(t)))},r.Email=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(20),[null].concat(t)))},r.Embedly=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(44),[null].concat(t)))},r.Entity=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(14),[null].concat(t)))},r.Fields=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(12),[null].concat(t)))},r.Helpers=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(8),[null].concat(t)))},r.Instagram=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(40),[null].concat(t)))},r.Jwt=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(39),[null].concat(t)))},r.Pdf=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(37),[null].concat(t)))},r.Roles=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(22),[null].concat(t)))},r.Schema=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(13),[null].concat(t)))},r.Settings=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(35),[null].concat(t)))},r.Shippo=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(34),[null].concat(t)))},r.Stripe=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(32),[null].concat(t)))},r.Taxonomy=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(29),[null].concat(t)))},r.Tools=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(28),[null].concat(t)))},r.User=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new(Function.prototype.bind.apply(n(27),[null].concat(t)))},e.exports=r}])});
//# sourceMappingURL=ace-api.js.map